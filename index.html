<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0; --filter-bg:#f0f7f3; --warning:#ffc107; --danger:#dc3545;
      
      /* New status colors */
      --status-onqueue: #b3e0ff; /* Pastel Blue */
      --status-offqueue: #d2b48c; /* Brown/Tan */
      --status-available: #c3e6cb; /* Green */
      --status-offline: #e2e3e5; /* Grey */
      --status-unavailable: #d6d8db; /* Darker Grey */
      --status-busy: #f5c6cb; /* Red */
      --status-meetings: #f8d7da; /* Red */
      --status-breaks: #ffeaa7; /* Orange/Yellow */
      --status-meal: #ffcc99; /* Orange */
      --status-away: #ffc107; /* Orange */
      --status-training: #c3e6cb; /* Green */
      
      /* Text colors for statuses */
      --status-onqueue-text: #0066cc;
      --status-offqueue-text: #8b4513;
      --status-available-text: #155724;
      --status-offline-text: #383d41;
      --status-unavailable-text: #383d41;
      --status-busy-text: #721c24;
      --status-meetings-text: #721c24;
      --status-breaks-text: #856404;
      --status-meal-text: #856404;
      --status-away-text: #856404;
      --status-training-text: #155724;
    }

    body{
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
      margin:20px;padding:20px;max-width:1800px;
      background:var(--light-bg);color:var(--text-color);
    }

    .card{
      background:var(--card-bg);
      border:1px solid var(--border-color);
      border-radius:12px;
      padding:24px;
      margin-top:16px;
      box-shadow:0 1px 3px rgba(0,0,0,.1);
    }

    label{display:block;font-weight:600;margin-bottom:6px}
    select,input,button{
      padding:10px;border:1px solid var(--border-color);
      border-radius:6px;background:var(--card-bg);font-size:14px
    }

    button{
      background:var(--primary-color);color:#fff;font-weight:600;
      cursor:pointer;transition:background .2s
    }
    button:hover{background:var(--secondary-color)}
    button:disabled{background:var(--text-light);cursor:not-allowed}

    .controls{
      display:flex;
      flex-wrap: wrap;
      gap:16px;
      align-items:flex-end;
    }

    .controls > div {
      flex: 1;
      min-width: 200px;
    }

    .full-width-btn{width:100%;padding:14px 18px;font-size:16px;margin-top:12px}
    .muted{color:var(--text-light);font-size:12px}
    .loading{opacity:.6;pointer-events:none}

    .filter-section{
      margin-bottom:20px;
      padding:15px;
      border:1px solid var(--border-color);
      border-radius:8px;
      background-color:var(--light-bg);
    }
    .filter-section h3{
      margin-top:0;color:var(--primary-color);
    }

    .table-container {
      overflow-x: auto;
      margin-top: 20px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      position: relative;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      /* Remove table-layout: fixed to allow resizing */
    }

    th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
      position: relative;
      user-select: none;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 80px; /* Minimum column width */
    }

    th, td {
      border: 1px solid var(--border-color);
      padding: 10px 12px;
      text-align: left;
      vertical-align: top;
      font-size: 13px;
    }

    /* Default column widths */
    th:nth-child(1), td:nth-child(1) { /* Name */
      width: 150px;
      min-width: 100px;
      max-width: 250px;
    }
    
    th:nth-child(2), td:nth-child(2) { /* Email */
      width: 200px;
      min-width: 150px;
      max-width: 300px;
    }
    
    th:nth-child(3), td:nth-child(3) { /* Role */
      width: 200px;
      min-width: 150px;
      max-width: 400px;
    }
    
    th:nth-child(4), td:nth-child(4) { /* Status */
      width: 120px;
      min-width: 100px;
      max-width: 150px;
    }
    
    th:nth-child(5), td:nth-child(5) { /* Team */
      width: 150px;
      min-width: 100px;
      max-width: 200px;
    }
    
    th:nth-child(6), td:nth-child(6) { /* Presence */
      width: 100px;
      min-width: 80px;
      max-width: 120px;
    }
    
    th:nth-child(7), td:nth-child(7) { /* Last Login */
      width: 150px;
      min-width: 120px;
      max-width: 180px;
    }
    
    th:nth-child(8), td:nth-child(8) { /* Days Since Login */
      width: 120px;
      min-width: 100px;
      max-width: 150px;
      text-align: center;
    }
    
    th:nth-child(9), td:nth-child(9) { /* Skills */
      width: 250px;
      min-width: 150px;
      max-width: 400px;
    }
    
    th:nth-child(10), td:nth-child(10) { /* Queues */
      width: 250px;
      min-width: 150px;
      max-width: 400px;
    }

    tr:hover {
      background-color: var(--pill);
    }

    .sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
      padding-right: 24px !important;
    }

    .sortable:hover {
      background-color: var(--secondary-color);
    }

    .sortable::after {
      content: '↕';
      position: absolute;
      right: 8px;
      font-size: 12px;
      opacity: 0.7;
    }

    .sortable.asc::after {
      content: '↑';
      opacity: 1;
    }

    .sortable.desc::after {
      content: '↓';
      opacity: 1;
    }

    .column-filter {
      display: block;
      width: 100%;
      padding: 6px 8px;
      margin-top: 4px;
      font-size: 12px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: var(--filter-bg);
    }

    .column-filter:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(99, 171, 143, 0.2);
    }

    .status-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Updated status color classes */
    .status-onqueue { background: var(--status-onqueue); color: var(--status-onqueue-text); }
    .status-offqueue { background: var(--status-offqueue); color: var(--status-offqueue-text); }
    .status-available { background: var(--status-available); color: var(--status-available-text); }
    .status-offline { background: var(--status-offline); color: var(--status-offline-text); }
    .status-unavailable { background: var(--status-unavailable); color: var(--status-unavailable-text); }
    .status-busy { background: var(--status-busy); color: var(--status-busy-text); }
    .status-meetings { background: var(--status-meetings); color: var(--status-meetings-text); }
    .status-breaks { background: var(--status-breaks); color: var(--status-breaks-text); }
    .status-meal { background: var(--status-meal); color: var(--status-meal-text); }
    .status-away { background: var(--status-away); color: var(--status-away-text); }
    .status-training { background: var(--status-training); color: var(--status-training-text); }
    .status-idle { background: var(--status-offline); color: var(--status-offline-text); }

    .action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 8px 12px;
      font-size: 12px;
      border-radius: 4px;
    }

    .export-btn {
      background: #6c757d;
    }

    .export-btn:hover {
      background: #5a6268;
    }

    .checkbox-dropdown{
      position:relative;min-width:240px;width:100%
    }
    .cd-trigger{
      display:flex;align-items:center;justify-content:space-between;
      border:1px solid var(--border-color);border-radius:6px;
      background:#fff;padding:10px;cursor:pointer;width:100%;
    }
    .cd-trigger .label{color:var(--text-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
    .cd-trigger .count{
      background:var(--pill);border:1px solid var(--border-color);
      border-radius:999px;padding:2px 8px;font-size:12px;
      color:#2c3e50;flex-shrink:0;margin-left:8px
    }

    .cd-panel{
      position:absolute;z-index:1000;margin-top:6px;background:#fff;
      border:1px solid var(--border-color);border-radius:8px;
      box-shadow:0 8px 24px rgba(0,0,0,.12);width:100%;
      max-height:340px;overflow:hidden;display:none
    }
    .cd-panel.open{display:block}

    .cd-header{
      padding:10px;border-bottom:1px solid var(--border-color);
      display:flex;gap:8px;align-items:center
    }
    .cd-search{
      flex:1;border:1px solid var(--border-color);border-radius:6px;
      padding:8px;width:100%;box-sizing:border-box
    }
    .cd-actions button{
      background:#eef6f2;color:#2c3e50;border:1px solid var(--border-color);
      border-radius:6px;padding:8px 10px;cursor:pointer;
    }

    .cd-selectall{
      padding:8px 12px;border-bottom:1px solid var(--border-color);
      display:flex;align-items:center;gap:10px
    }

    .cd-list{max-height:260px;overflow:auto}
    .cd-item{
      display:flex;align-items:center;gap:10px;
      padding:8px 12px;border-bottom:1px solid #f1f3f5
    }

    .cd-footer{
      padding:8px 12px;background:#fafafa;border-top:1px solid var(--border-color);
      font-size:12px;color:var(--text-light);display:flex;justify-content:space-between
    }

    .stats-bar {
      display: flex;
      gap: 20px;
      padding: 12px 16px;
      background: var(--filter-bg);
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 14px;
      flex-wrap: wrap;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      min-width: 80px;
    }

    .stat-value {
      font-weight: 700;
      font-size: 18px;
      color: var(--primary-color);
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-light);
    }

    .progress-container {
      margin: 20px 0;
      background: var(--light-bg);
      border-radius: 8px;
      padding: 15px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--border-color);
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: var(--primary-color);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .progress-text {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-light);
    }

    .rate-limit-info {
      background: var(--warning);
      color: #856404;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      margin-top: 8px;
      display: none;
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 20px;
    }

    .tab {
      padding: 12px 24px;
      cursor: pointer;
      border: none;
      background: none;
      font-weight: 600;
      color: var(--text-light);
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }

    .tab.active {
      color: var(--primary-color);
      border-bottom: 3px solid var(--primary-color);
    }

    .tab:hover {
      color: var(--primary-color);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .inactive-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
      padding: 15px;
      background: var(--filter-bg);
      border-radius: 8px;
    }

    .days-input {
      width: 100px;
    }

    .date-range-inputs {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .date-range-inputs input {
      flex: 1;
    }

    /* Updated styles for Roles, Skills, and Queues */
    .roles-list, .skills-list, .queues-list {
      max-height: 100px;
      overflow-y: auto;
      padding: 5px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: var(--light-bg);
    }

    .roles-list span, .skills-list span, .queues-list span {
      display: inline-block;
      background: var(--pill);
      padding: 2px 6px;
      margin: 2px;
      border-radius: 3px;
      font-size: 11px;
      white-space: normal;
      word-break: break-word;
      max-width: 100%;
    }

    /* Column Resizing */
    .resizer {
      position: absolute;
      right: 0;
      top: 0;
      height: 100%;
      width: 5px;
      background: transparent;
      cursor: col-resize;
      user-select: none;
      touch-action: none;
      z-index: 20;
    }

    .resizer:hover,
    .resizer.resizing {
      background: var(--secondary-color);
    }

    .resizer::after {
      content: '';
      position: absolute;
      right: 2px;
      top: 0;
      height: 100%;
      width: 1px;
      background: rgba(255, 255, 255, 0.3);
    }

    /* Allow content wrapping in certain columns */
    td:nth-child(3), td:nth-child(9), td:nth-child(10) { /* Role, Skills, Queues */
      white-space: normal;
      word-wrap: break-word;
    }

    @media (max-width: 1200px) {
      .controls {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }
    }

    @media (max-width: 768px) {
      body {
        margin: 10px;
        padding: 10px;
      }
      
      .controls {
        grid-template-columns: 1fr;
      }
      
      .stats-bar {
        gap: 10px;
      }
      
      .action-buttons {
        flex-direction: column;
      }
    }

    .error-message{
      color:#d9534f;padding:10px;margin:10px 0;
      border:1px solid #d9534f;border-radius:4px;background:#f9f2f2;
    }
    .success-message{
      color:#3c763d;padding:10px;margin:10px 0;
      border:1px solid #3c763d;border-radius:4px;background:#dff0d8;
    }
    
    .info-message{
      color:#0c5460;padding:10px;margin:10px 0;
      border:1px solid #bee5eb;border-radius:4px;background:#d1ecf1;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      display: none;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid var(--light-bg);
      border-top: 5px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <div id="loginSection" class="card" style="text-align:center;margin:20px;">
    <div class="loading">Authenticating with PureCloud...</div>
  </div>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
  </div>

  <div id="appContent" style="display:none;">
    <div id="messageContainer" style="display:none;"></div>

    <h1 style="margin-bottom: 20px;">User Management Dashboard</h1>

    <div class="tabs">
      <button class="tab active" data-tab="active-users">Active Users</button>
      <button class="tab" data-tab="inactive-users">Inactive Users</button>
    </div>

    <!-- Active Users Tab -->
    <div id="active-users" class="tab-content active">
      <div class="filter-section card">
        <h3>Filter Users</h3>
        
        <div class="controls">
          <div>
            <label>Select Management Units</label>
            <div id="managementUnitDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>Select Teams</label>
            <div id="teamDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>Filter by Status</label>
            <select id="statusFilter">
              <option value="">All Statuses</option>
              <option value="ON_QUEUE">On Queue</option>
              <option value="OFF_QUEUE">Off Queue</option>
              <option value="AVAILABLE">Available</option>
              <option value="OFFLINE">Offline</option>
              <option value="UNAVAILABLE">Unavailable</option>
              <option value="BUSY">Busy</option>
              <option value="MEETINGS">Meetings</option>
              <option value="BREAKS">Breaks</option>
              <option value="MEAL">Meal</option>
              <option value="AWAY">Away</option>
              <option value="TRAINING">Training</option>
              <option value="IDLE">Idle</option>
            </select>
          </div>
          <div>
            <label>Search Users</label>
            <input type="text" id="globalSearch" placeholder="Search name, email, skills..." />
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="fetchUsers" class="full-width-btn">Load Users</button>
          </div>
        </div>
        
        <div id="rateLimitInfo" class="rate-limit-info">
          Rate limit: <span id="rateLimitRemaining">100</span> remaining, resets in <span id="rateLimitReset">60</span>s
        </div>
      </div>

      <div class="card">
        <div id="progressContainer" class="progress-container" style="display:none;">
          <div class="progress-text">
            <span id="progressStatus">Loading users...</span>
            <span id="progressPercent">0%</span>
          </div>
          <div class="progress-bar">
            <div id="progressFill" class="progress-fill" style="width: 0%"></div>
          </div>
          <div class="progress-text">
            <span id="progressCount">0</span> of <span id="progressTotal">0</span> users loaded
          </div>
        </div>

        <div class="action-buttons">
          <button id="refreshData" class="action-btn">Refresh Data</button>
          <button id="exportCSV" class="action-btn export-btn">Export to CSV</button>
          <button id="clearFilters" class="action-btn" style="background: var(--danger);">Clear Filters</button>
          <button id="resetColumnWidths" class="action-btn" style="background: var(--warning); color: #000;">Reset Column Sizes</button>
          <select id="pageSize" style="margin-left: auto; width: auto;">
            <option value="25">25 per page</option>
            <option value="50" selected>50 per page</option>
            <option value="100">100 per page</option>
            <option value="200">200 per page</option>
          </select>
        </div>

        <div class="stats-bar" id="statsBar">
          <div class="stat-item">
            <span class="stat-value" id="totalUsers">0</span>
            <span class="stat-label">Total Users</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="onlineUsers">0</span>
            <span class="stat-label">Online</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="activeUsers">0</span>
            <span class="stat-label">Active Today</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="awayUsers">0</span>
            <span class="stat-label">Away</span>
          </div>
        </div>

        <div class="table-container">
          <table id="usersTable">
            <thead>
              <tr>
                <th class="sortable" data-column="name">Name</th>
                <th class="sortable" data-column="email">Email</th>
                <th class="sortable" data-column="roles">Role</th>
                <th class="sortable" data-column="routingStatus.status">Status</th>
                <th class="sortable" data-column="team.name">Team</th>
                <th class="sortable" data-column="presence.presenceDefinition.systemPresence">Presence</th>
                <th class="sortable" data-column="dateLastLogin">Last Login</th>
                <th class="sortable" data-column="daysSinceLastLogin">Days Since Login</th>
                <th class="sortable" data-column="skills">Skills</th>
                <th>Queues</th>
              </tr>
              <tr class="filter-row">
                <td><input type="text" class="column-filter" data-column="name" placeholder="Filter name..."></td>
                <td><input type="text" class="column-filter" data-column="email" placeholder="Filter email..."></td>
                <td><input type="text" class="column-filter" data-column="roles" placeholder="Filter role..."></td>
                <td><select class="column-filter" data-column="routingStatus.status">
                  <option value="">All</option>
                  <option value="ON_QUEUE">On Queue</option>
                  <option value="OFF_QUEUE">Off Queue</option>
                  <option value="AVAILABLE">Available</option>
                  <option value="OFFLINE">Offline</option>
                  <option value="UNAVAILABLE">Unavailable</option>
                  <option value="BUSY">Busy</option>
                  <option value="MEETINGS">Meetings</option>
                  <option value="BREAKS">Breaks</option>
                  <option value="MEAL">Meal</option>
                  <option value="AWAY">Away</option>
                  <option value="TRAINING">Training</option>
                  <option value="IDLE">Idle</option>
                </select></td>
                <td><input type="text" class="column-filter" data-column="team.name" placeholder="Filter team..."></td>
                <td><select class="column-filter" data-column="presence.presenceDefinition.systemPresence">
                  <option value="">All</option>
                  <option value="On Queue">On Queue</option>
                  <option value="Off Queue">Off Queue</option>
                  <option value="Available">Available</option>
                  <option value="Offline">Offline</option>
                  <option value="Unavailable">Unavailable</option>
                  <option value="Busy">Busy</option>
                  <option value="Meetings">Meetings</option>
                  <option value="Breaks">Breaks</option>
                  <option value="Meal">Meal</option>
                  <option value="Away">Away</option>
                  <option value="Training">Training</option>
                  <option value="Idle">Idle</option>
                </select></td>
                <td><input type="text" class="column-filter" data-column="dateLastLogin" placeholder="YYYY-MM-DD..."></td>
                <td><input type="text" class="column-filter" data-column="daysSinceLastLogin" placeholder="Min days..."></td>
                <td><input type="text" class="column-filter" data-column="skills" placeholder="Filter skills..."></td>
                <td></td>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
          <div id="paginationInfo" class="muted"></div>
          <div>
            <button id="prevPage" class="action-btn" disabled>Previous</button>
            <button id="nextPage" class="action-btn" disabled>Next</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Inactive Users Tab -->
    <div id="inactive-users" class="tab-content">
      <div class="filter-section card">
        <h3>Find Inactive Users</h3>
        
        <div class="inactive-controls">
          <div>
            <label>Days Since Last Login (minimum)</label>
            <input type="number" id="daysSinceLogin" class="days-input" min="1" value="30" placeholder="30">
          </div>
          <div>
            <label>Date Range (optional)</label>
            <div class="date-range-inputs">
              <input type="date" id="dateFrom" placeholder="From date">
              <span>to</span>
              <input type="date" id="dateTo" placeholder="To date">
            </div>
          </div>
          <div>
            <label>Filter by Team</label>
            <select id="inactiveTeamFilter">
              <option value="">All Teams</option>
            </select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="findInactiveUsers" class="full-width-btn">Find Inactive Users</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="action-buttons">
          <button id="exportInactiveCSV" class="action-btn export-btn">Export Inactive Users to CSV</button>
          <button id="resetInactiveColumnWidths" class="action-btn" style="background: var(--warning); color: #000;">Reset Column Sizes</button>
        </div>

        <div class="stats-bar" id="inactiveStatsBar">
          <div class="stat-item">
            <span class="stat-value" id="totalInactiveUsers">0</span>
            <span class="stat-label">Inactive Users</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="avgDaysInactive">0</span>
            <span class="stat-label">Avg Days Inactive</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="maxDaysInactive">0</span>
            <span class="stat-label">Max Days Inactive</span>
          </div>
        </div>

        <div class="table-container">
          <table id="inactiveUsersTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Team</th>
                <th>Last Login</th>
                <th>Days Since Login</th>
                <th>Status</th>
                <th>Queues</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const clientId = 'fe305808-b368-4547-8af9-325d28d552bb';
    const redirectUri = 'https://gmcglynn88.github.io/Profiles/';
    const oauthUrl =
      `https://login.mypurecloud.ie/oauth/authorize?client_id=${clientId}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}`;

    let token = null;
    let availableUsers = [];
    let availableTeams = [];
    let availableManagementUnits = [];
    let userQueuesCache = new Map();
    
    let rateLimitRemaining = 100;
    let rateLimitResetTime = Date.now() + 60000;
    
    let currentPage = 1;
    let pageSize = 50;
    let sortColumn = 'name';
    let sortDirection = 'asc';
    let filters = {};
    let globalSearch = '';
    let filteredUsers = [];
    
    let inactiveUsers = [];
    
    // Column resizing variables
    let activeResizer = null;
    let startX = 0;
    let startWidth = 0;
    let columnIndex = 0;
    let tableElement = null;
    let originalWidths = {};
    
    const MAX_PAGE_SIZE = 100;
    const REQUEST_DELAY = 200;
    let isFetching = false;

    // Status color mapping function
    function getStatusClass(presence) {
      if (!presence) return 'status-offline';
      
      const status = String(presence).toLowerCase().trim();
      
      if (status.includes('on queue') || status === 'on_queue') return 'status-onqueue';
      if (status.includes('off queue') || status === 'off_queue') return 'status-offqueue';
      if (status.includes('available')) return 'status-available';
      if (status.includes('offline')) return 'status-offline';
      if (status.includes('unavailable')) return 'status-unavailable';
      if (status.includes('busy')) return 'status-busy';
      if (status.includes('meeting')) return 'status-meetings';
      if (status.includes('break')) return 'status-breaks';
      if (status.includes('meal')) return 'status-meal';
      if (status.includes('away')) return 'status-away';
      if (status.includes('train')) return 'status-training';
      if (status.includes('idle')) return 'status-idle';
      
      // Default fallback
      return 'status-offline';
    }

    document.addEventListener('DOMContentLoaded', () => {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      token = params.get("access_token");

      if (!token) {
        window.location.href = oauthUrl;
        return;
      }

      document.getElementById("loginSection").style.display = "none";
      document.getElementById("appContent").style.display = "block";

      initializeApp();
    });

    function showMessage(message, type = 'error') {
      const msgBox = document.getElementById('messageContainer');
      msgBox.innerHTML = `<div class="${type}-message">${message}</div>`;
      msgBox.style.display = 'block';
      if (type === 'success') setTimeout(() => (msgBox.style.display = 'none'), 5000);
    }

    function authHeaders() {
      return { 
        Authorization: `Bearer ${token}`, 
        "Content-Type": "application/json" 
      };
    }

    function updateRateLimitInfo(headers) {
      if (headers) {
        const remaining = headers.get('RateLimit-Remaining');
        const reset = headers.get('RateLimit-Reset');
        
        if (remaining !== null) {
          rateLimitRemaining = parseInt(remaining);
          document.getElementById('rateLimitRemaining').textContent = remaining;
        }
        
        if (reset !== null) {
          const resetSeconds = parseInt(reset);
          rateLimitResetTime = Date.now() + (resetSeconds * 1000);
          document.getElementById('rateLimitReset').textContent = resetSeconds;
          
          if (rateLimitRemaining < 20) {
            document.getElementById('rateLimitInfo').style.display = 'block';
            document.getElementById('rateLimitInfo').style.background = 'var(--warning)';
          } else if (rateLimitRemaining < 50) {
            document.getElementById('rateLimitInfo').style.display = 'block';
          } else {
            document.getElementById('rateLimitInfo').style.display = 'none';
          }
        }
      }
    }

    async function rateLimitedFetch(url, options = {}) {
      if (rateLimitRemaining < 5) {
        const waitTime = rateLimitResetTime - Date.now();
        if (waitTime > 0) {
          showMessage(`Rate limit reached. Waiting ${Math.ceil(waitTime / 1000)} seconds...`, 'info');
          await new Promise(resolve => setTimeout(resolve, waitTime));
        }
      }
      
      if (isFetching) {
        await new Promise(resolve => setTimeout(resolve, REQUEST_DELAY));
      }
      
      const response = await fetch(url, {
        ...options,
        headers: { ...authHeaders(), ...options.headers }
      });
      
      updateRateLimitInfo(response.headers);
      
      if (!response.ok) {
        if (response.status === 429) {
          const retryAfter = response.headers.get('Retry-After') || 60;
          showMessage(`Rate limited. Retrying in ${retryAfter} seconds...`, 'info');
          await new Promise(resolve => setTimeout(resolve, retryAfter * 1000));
          return rateLimitedFetch(url, options);
        }
        throw new Error(`API error: ${response.status} ${response.statusText}`);
      }
      
      return response;
    }

    async function initializeApp() {
      try {
        showLoading(true);
        await Promise.all([
          fetchAllTeams(),
          fetchAllManagementUnits()
        ]);

        createDropdowns();
        populateDropdownOptions();
        setupEventListeners();
        setupTabs();
        showLoading(false);

      } catch (e) {
        console.error(e);
        showMessage("Error initialising. Redirecting...");
        setTimeout(() => window.location.href = oauthUrl, 2000);
      }
    }

    async function fetchAllTeams() {
      let all = [], page = 1;
      const size = 100;
      
      try {
        do {
          const res = await rateLimitedFetch(
            `https://api.mypurecloud.ie/api/v2/teams?pageNumber=${page}&pageSize=${size}`
          );
          const data = await res.json();
          all = all.concat(data.entities || []);
          page++;
          
          if (!data.entities || data.entities.length < size) break;
          
        } while (true);
        
        availableTeams = all;
        
        // Populate team filter for inactive users
        const teamFilter = document.getElementById('inactiveTeamFilter');
        availableTeams.forEach(team => {
          const option = document.createElement('option');
          option.value = team.id;
          option.textContent = team.name;
          teamFilter.appendChild(option);
        });
        
      } catch (error) {
        console.error('Error fetching teams:', error);
        showMessage('Error loading teams');
      }
    }

    async function fetchAllManagementUnits() {
      let all = [], page = 1;
      const size = 100;
      
      try {
        do {
          const res = await rateLimitedFetch(
            `https://api.mypurecloud.ie/api/v2/workforcemanagement/managementunits?pageNumber=${page}&pageSize=${size}`
          );
          const data = await res.json();
          all = all.concat(data.entities || []);
          page++;
          
          if (!data.entities || data.entities.length < size) break;
          
        } while (true);
        
        availableManagementUnits = all;
      } catch (error) {
        console.error('Error fetching management units:', error);
        showMessage('Error loading management units');
      }
    }

    async function fetchUserQueues(userId) {
      if (userQueuesCache.has(userId)) {
        return userQueuesCache.get(userId);
      }
      
      try {
        const response = await rateLimitedFetch(
          `https://api.mypurecloud.ie/api/v2/users/${userId}/queues?pageSize=50`
        );
        const data = await response.json();
        const queues = data.entities || [];
        const queueNames = queues.map(q => q.name).slice(0, 10); // Limit to 10 queues
        userQueuesCache.set(userId, queueNames);
        return queueNames;
      } catch (error) {
        console.error(`Error fetching queues for user ${userId}:`, error);
        return [];
      }
    }

    async function fetchUsers() {
      if (isFetching) {
        showMessage('Already fetching data, please wait...', 'info');
        return;
      }
      
      try {
        isFetching = true;
        document.getElementById('fetchUsers').disabled = true;
        document.getElementById('fetchUsers').textContent = 'Loading...';
        
        const progressContainer = document.getElementById('progressContainer');
        progressContainer.style.display = 'block';
        
        const expandFields = [
          'routingStatus',
          'presence',
          'integrationPresence',
          'conversationSummary',
          'outOfOffice',
          'geolocation',
          'station',
          'authorization',
          'lasttokenissued',
          'authorization.unusedRoles',
          'team',
          'workPlanBidRanks',
          'externalContactsSettings',
          'groups',
          'customAttributes',
          'profileSkills',
          'certifications',
          'skills',
          'languages',
          'languagePreference',
          'employerInfo',
          'biography',
          'dateLastLogin',
          'dateWelcomeSent'
        ].join(',');

        let allUsers = [];
        let page = 1;
        let totalUsers = 0;
        let loadedCount = 0;
        
        try {
          const countRes = await rateLimitedFetch(
            `https://api.mypurecloud.ie/api/v2/users?pageSize=1&pageNumber=1`
          );
          const countData = await countRes.json();
          totalUsers = countData.total || 0;
          document.getElementById('progressTotal').textContent = totalUsers;
        } catch (error) {
          console.warn('Could not get total count:', error);
          totalUsers = 1000;
        }

        while (true) {
          try {
            document.getElementById('progressStatus').textContent = `Loading page ${page}...`;
            
            const res = await rateLimitedFetch(
              `https://api.mypurecloud.ie/api/v2/users?expand=${expandFields}&pageNumber=${page}&pageSize=${MAX_PAGE_SIZE}`
            );
            
            const data = await res.json();
            const users = data.entities || [];
            
            const validUsers = users.filter(u => 
              u.name && u.name.trim() && u.name !== 'Unknown User'
            );
            
            // Calculate days since last login for each user
            validUsers.forEach(user => {
              if (user.dateLastLogin) {
                const lastLogin = new Date(user.dateLastLogin);
                const today = new Date();
                const diffTime = Math.abs(today - lastLogin);
                user.daysSinceLastLogin = Math.floor(diffTime / (1000 * 60 * 60 * 24));
              } else {
                user.daysSinceLastLogin = 999; // Never logged in
              }
              
              // Extract roles
              if (user.authorization && user.authorization.roles) {
                user.roles = user.authorization.roles.map(r => r.name);
              } else {
                user.roles = [];
              }
            });
            
            allUsers = allUsers.concat(validUsers);
            loadedCount += users.length;
            
            const progressPercent = Math.min(Math.round((loadedCount / totalUsers) * 100), 100);
            document.getElementById('progressFill').style.width = `${progressPercent}%`;
            document.getElementById('progressPercent').textContent = `${progressPercent}%`;
            document.getElementById('progressCount').textContent = loadedCount;
            
            if (!data.pageCount || page >= data.pageCount || users.length < MAX_PAGE_SIZE) {
              break;
            }
            
            page++;
            
            await new Promise(resolve => setTimeout(resolve, REQUEST_DELAY));
            
          } catch (error) {
            console.error(`Error fetching page ${page}:`, error);
            
            if (error.message.includes('429')) {
              await new Promise(resolve => setTimeout(resolve, 5000));
              continue;
            }
            
            showMessage(`Stopped loading at page ${page}. ${error.message}`, 'warning');
            break;
          }
        }
        
        availableUsers = allUsers;
        
        progressContainer.style.display = 'none';
        
        // Initialize column resizing after users are loaded
        setupColumnResizing();
        
        applyFilters();
        renderTable();
        
        showMessage(`Successfully loaded ${availableUsers.length} users`, 'success');
        
      } catch (error) {
        console.error('Error fetching users:', error);
        showMessage(`Error loading users: ${error.message}`);
        
        document.getElementById('progressContainer').style.display = 'none';
      } finally {
        isFetching = false;
        document.getElementById('fetchUsers').disabled = false;
        document.getElementById('fetchUsers').textContent = 'Load Users';
      }
    }

    function applyFilters() {
      filteredUsers = [...availableUsers];
      
      if (globalSearch) {
        const search = globalSearch.toLowerCase();
        filteredUsers = filteredUsers.filter(user => {
          return (
            (user.name && user.name.toLowerCase().includes(search)) ||
            (user.email && user.email.toLowerCase().includes(search)) ||
            (user.roles && user.roles.some(role => role.toLowerCase().includes(search))) ||
            (user.skills && user.skills.some(skill => 
              skill.name && skill.name.toLowerCase().includes(search)
            )) ||
            (user.team && user.team.name && user.team.name.toLowerCase().includes(search))
          );
        });
      }
      
      Object.keys(filters).forEach(column => {
        const filterValue = filters[column].toLowerCase().trim();
        if (!filterValue) return;
        
        filteredUsers = filteredUsers.filter(user => {
          const value = getNestedValue(user, column);
          
          if (value === undefined || value === null) return false;
          
          if (Array.isArray(value)) {
            return value.some(item => 
              String(item).toLowerCase().includes(filterValue)
            );
          }
          
          if (column.includes('date') || column.includes('Date')) {
            const dateStr = new Date(value).toISOString().split('T')[0];
            return dateStr.includes(filterValue);
          }
          
          if (column.includes('daysSinceLastLogin')) {
            const days = parseInt(value) || 0;
            const filterDays = parseInt(filterValue) || 0;
            return days >= filterDays;
          }
          
          return String(value).toLowerCase().includes(filterValue);
        });
      });
      
      const statusFilter = document.getElementById('statusFilter').value;
      if (statusFilter) {
        filteredUsers = filteredUsers.filter(user => {
          if (!user.presence || !user.presence.presenceDefinition) return false;
          return user.presence.presenceDefinition.systemPresence === statusFilter;
        });
      }
      
      const selectedTeams = teamDropdown.getSelectedValues();
      if (selectedTeams.length > 0) {
        filteredUsers = filteredUsers.filter(user => 
          user.team && selectedTeams.includes(user.team.id)
        );
      }
      
      const selectedMUs = managementUnitDropdown.getSelectedValues();
      if (selectedMUs.length > 0) {
        filteredUsers = filteredUsers.filter(user => {
          return user.team && selectedTeams.length > 0;
        });
      }
      
      updateStats();
    }

    function getNestedValue(obj, path) {
      return path.split('.').reduce((current, key) => {
        return current ? current[key] : undefined;
      }, obj);
    }

    function sortUsers(users) {
      return users.sort((a, b) => {
        let valA = getNestedValue(a, sortColumn);
        let valB = getNestedValue(b, sortColumn);
        
        if (Array.isArray(valA)) {
          valA = valA.map(v => v.name || v).join(', ');
        }
        if (Array.isArray(valB)) {
          valB = valB.map(v => v.name || v).join(', ');
        }
        
        if (sortColumn.includes('date') || sortColumn.includes('Date') || sortColumn === 'dateLastLogin') {
          valA = valA ? new Date(valA).getTime() : 0;
          valB = valB ? new Date(valB).getTime() : 0;
        }
        
        if (sortColumn === 'daysSinceLastLogin') {
          valA = Number(valA) || 0;
          valB = Number(valB) || 0;
        }
        
        valA = String(valA || '').toLowerCase();
        valB = String(valB || '').toLowerCase();
        
        if (sortDirection === 'asc') {
          return valA.localeCompare(valB, undefined, { numeric: true });
        } else {
          return valB.localeCompare(valA, undefined, { numeric: true });
        }
      });
    }

    async function renderTable() {
      const tbody = document.querySelector('#usersTable tbody');
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageUsers = sortUsers([...filteredUsers]).slice(start, end);
      
      if (pageUsers.length === 0) {
        tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--text-light)}">
          No users found. Try adjusting your filters or click "Load Users".
        </td></tr>`;
        updatePaginationInfo(0, 0);
        return;
      }
      
      // Fetch queues for all users on the page
      const queuePromises = pageUsers.map(user => fetchUserQueues(user.id));
      const queuesList = await Promise.all(queuePromises);
      
      tbody.innerHTML = pageUsers.map((user, index) => {
        const status = user.routingStatus?.status || 'UNKNOWN';
        const presence = user.presence?.presenceDefinition?.systemPresence || 'Offline';
        const team = user.team?.name || 'Unassigned';
        const lastLogin = user.dateLastLogin ? 
          new Date(user.dateLastLogin).toLocaleDateString() + ' ' + 
          new Date(user.dateLastLogin).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) 
          : 'Never';
        const skills = user.skills?.map(s => s.name) || [];
        const daysSinceLogin = user.daysSinceLastLogin || 0;
        const roles = user.roles || [];
        const userQueues = queuesList[index] || [];
        const statusClass = getStatusClass(presence);
        
        let daysClass = '';
        if (daysSinceLogin > 30) daysClass = 'style="color: var(--danger); font-weight: bold;"';
        else if (daysSinceLogin > 7) daysClass = 'style="color: var(--warning);"';
        
        return `
          <tr>
            <td><strong>${user.name || 'Unknown'}</strong></td>
            <td>${user.email || 'No email'}</td>
            <td>
              <div class="roles-list" title="${roles.join(', ') || 'No role'}">
                ${roles.slice(0, 5).map(role => `<span>${role}</span>`).join('')}
                ${roles.length > 5 ? '<span>...</span>' : ''}
                ${roles.length === 0 ? '<span style="color: var(--text-light);">No role</span>' : ''}
              </div>
            </td>
            <td>
              <span class="status-badge ${statusClass}">${presence}</span><br>
              <small class="muted">${status}</small>
            </td>
            <td>${team}</td>
            <td>${presence}</td>
            <td>${lastLogin}</td>
            <td style="text-align:center;" ${daysClass}>${daysSinceLogin === 999 ? 'Never' : daysSinceLogin}</td>
            <td>
              <div class="skills-list" title="${skills.join(', ') || 'None'}">
                ${skills.slice(0, 5).map(skill => `<span>${skill}</span>`).join('')}
                ${skills.length > 5 ? '<span>...</span>' : ''}
                ${skills.length === 0 ? '<span style="color: var(--text-light);">None</span>' : ''}
              </div>
            </td>
            <td>
              <div class="queues-list" title="${userQueues.join(', ')}">
                ${userQueues.slice(0, 5).map(queue => `<span>${queue}</span>`).join('')}
                ${userQueues.length > 5 ? '<span>...</span>' : ''}
                ${userQueues.length === 0 ? '<span style="color: var(--text-light);">None</span>' : ''}
              </div>
            </td>
          </tr>
        `;
      }).join('');
      
      updatePaginationInfo(start, end);
      updateSortIndicators();
    }

    function updatePaginationInfo(start, end) {
      const total = filteredUsers.length;
      document.getElementById('paginationInfo').textContent = 
        `Showing ${start + 1}-${Math.min(end, total)} of ${total} users`;
      
      document.getElementById('prevPage').disabled = currentPage === 1;
      document.getElementById('nextPage').disabled = end >= total;
    }

    function updateSortIndicators() {
      document.querySelectorAll('.sortable').forEach(th => {
        th.classList.remove('asc', 'desc');
        if (th.dataset.column === sortColumn) {
          th.classList.add(sortDirection);
        }
      });
    }

    function updateStats() {
      const total = filteredUsers.length;
      const online = filteredUsers.filter(u => 
        u.presence?.presenceDefinition?.systemPresence === 'Available' || 
        u.presence?.presenceDefinition?.systemPresence === 'On Queue'
      ).length;
      const active = filteredUsers.filter(u => {
        if (!u.dateLastLogin) return false;
        const lastLogin = new Date(u.dateLastLogin);
        const today = new Date();
        return lastLogin.toDateString() === today.toDateString();
      }).length;
      const away = filteredUsers.filter(u => {
        const presence = u.presence?.presenceDefinition?.systemPresence || '';
        return presence === 'Away' || presence === 'Breaks' || presence === 'Meal';
      }).length;
      
      document.getElementById('totalUsers').textContent = total;
      document.getElementById('onlineUsers').textContent = online;
      document.getElementById('activeUsers').textContent = active;
      document.getElementById('awayUsers').textContent = away;
    }

    // Column Resizing Functions
    function setupColumnResizing() {
      const table = document.getElementById('usersTable');
      tableElement = table;
      const headers = table.querySelectorAll('thead tr:first-child th');
      
      // Store original widths
      headers.forEach((header, index) => {
        originalWidths[index] = header.getBoundingClientRect().width;
      });
      
      // Add resizer to each header
      headers.forEach((header, index) => {
        const resizer = document.createElement('div');
        resizer.classList.add('resizer');
        resizer.dataset.index = index;
        header.appendChild(resizer);
        
        // Make header position relative if not already
        header.style.position = 'relative';
        
        // Add event listeners for resizing
        resizer.addEventListener('mousedown', startResize);
        resizer.addEventListener('touchstart', startResizeTouch);
      });
      
      // Setup resizing for inactive users table too
      const inactiveTable = document.getElementById('inactiveUsersTable');
      if (inactiveTable) {
        setupInactiveColumnResizing(inactiveTable);
      }
    }
    
    function setupInactiveColumnResizing(table) {
      const headers = table.querySelectorAll('thead tr:first-child th');
      
      headers.forEach((header, index) => {
        const resizer = document.createElement('div');
        resizer.classList.add('resizer');
        resizer.dataset.index = index;
        header.appendChild(resizer);
        
        header.style.position = 'relative';
        
        resizer.addEventListener('mousedown', startResize);
        resizer.addEventListener('touchstart', startResizeTouch);
      });
    }
    
    function startResize(e) {
      e.preventDefault();
      activeResizer = e.target;
      columnIndex = parseInt(activeResizer.dataset.index);
      startX = e.clientX || e.pageX;
      
      const header = activeResizer.parentElement;
      startWidth = header.getBoundingClientRect().width;
      
      activeResizer.classList.add('resizing');
      
      document.addEventListener('mousemove', resize);
      document.addEventListener('mouseup', stopResize);
    }
    
    function startResizeTouch(e) {
      e.preventDefault();
      activeResizer = e.target;
      columnIndex = parseInt(activeResizer.dataset.index);
      startX = e.touches[0].clientX;
      
      const header = activeResizer.parentElement;
      startWidth = header.getBoundingClientRect().width;
      
      activeResizer.classList.add('resizing');
      
      document.addEventListener('touchmove', resizeTouch);
      document.addEventListener('touchend', stopResize);
    }
    
    function resize(e) {
      if (!activeResizer) return;
      
      const currentX = e.clientX || e.pageX;
      const dx = currentX - startX;
      const newWidth = Math.max(50, startWidth + dx); // Minimum 50px
      
      const header = activeResizer.parentElement;
      const table = header.closest('table');
      const allHeaders = table.querySelectorAll('thead tr:first-child th');
      const allRows = table.querySelectorAll('tbody tr');
      
      // Update header width
      header.style.width = `${newWidth}px`;
      
      // Update all cells in this column
      allRows.forEach(row => {
        const cell = row.querySelector(`td:nth-child(${columnIndex + 1})`);
        if (cell) {
          cell.style.width = `${newWidth}px`;
        }
      });
      
      // Prevent text selection during resize
      e.preventDefault();
    }
    
    function resizeTouch(e) {
      if (!activeResizer) return;
      
      const currentX = e.touches[0].clientX;
      const dx = currentX - startX;
      const newWidth = Math.max(50, startWidth + dx);
      
      const header = activeResizer.parentElement;
      const table = header.closest('table');
      const allHeaders = table.querySelectorAll('thead tr:first-child th');
      const allRows = table.querySelectorAll('tbody tr');
      
      header.style.width = `${newWidth}px`;
      allRows.forEach(row => {
        const cell = row.querySelector(`td:nth-child(${columnIndex + 1})`);
        if (cell) {
          cell.style.width = `${newWidth}px`;
        }
      });
    }
    
    function stopResize() {
      if (!activeResizer) return;
      
      activeResizer.classList.remove('resizing');
      activeResizer = null;
      
      document.removeEventListener('mousemove', resize);
      document.removeEventListener('mouseup', stopResize);
      document.removeEventListener('touchmove', resizeTouch);
      document.removeEventListener('touchend', stopResize);
    }
    
    function resetColumnWidths() {
      const table = document.getElementById('usersTable');
      const headers = table.querySelectorAll('thead tr:first-child th');
      const rows = table.querySelectorAll('tbody tr');
      
      headers.forEach((header, index) => {
        // Remove inline width styles to revert to CSS defaults
        header.style.width = '';
        
        // Remove width from all cells in this column
        rows.forEach(row => {
          const cell = row.querySelector(`td:nth-child(${index + 1})`);
          if (cell) {
            cell.style.width = '';
          }
        });
      });
      
      showMessage('Column sizes reset to default', 'success');
    }
    
    function resetInactiveColumnWidths() {
      const table = document.getElementById('inactiveUsersTable');
      const headers = table.querySelectorAll('thead tr:first-child th');
      const rows = table.querySelectorAll('tbody tr');
      
      headers.forEach((header, index) => {
        header.style.width = '';
        rows.forEach(row => {
          const cell = row.querySelector(`td:nth-child(${index + 1})`);
          if (cell) {
            cell.style.width = '';
          }
        });
      });
      
      showMessage('Inactive users column sizes reset', 'success');
    }

    let teamDropdown, managementUnitDropdown;

    function createCheckboxDropdown(containerId, {placeholder, searchPlaceholder}) {
      const root = document.getElementById(containerId);
      root.innerHTML = '';

      const trigger = document.createElement('div');
      trigger.className = 'cd-trigger';
      trigger.innerHTML = `<span class="label">${placeholder}</span><span class="count">0 selected</span>`;
      root.appendChild(trigger);

      const panel = document.createElement('div');
      panel.className = 'cd-panel';
      panel.innerHTML = `
        <div class="cd-header">
          <input type="text" class="cd-search" placeholder="${searchPlaceholder}" />
          <div class="cd-actions"><button data-cd="clear">Clear</button></div>
        </div>
        <div class="cd-selectall"><label><input type="checkbox" data-cd="selectall"/> Select all</label></div>
        <div class="cd-list"></div>
        <div class="cd-footer"><span data-cd="summary">0 selected</span><span>Click outside to close</span></div>
      `;
      root.appendChild(panel);

      const list = panel.querySelector('.cd-list');
      const search = panel.querySelector('.cd-search');
      const clearBtn = panel.querySelector('[data-cd="clear"]');
      const selectAll = panel.querySelector('[data-cd="selectall"]');
      const summary = panel.querySelector('[data-cd="summary"]');

      let options = [], selected = new Set();

      function render(filter = '') {
        const ft = filter.toLowerCase().trim();
        list.innerHTML = '';
        const filtered = !ft ? options : options.filter(o => (o.label || '').toLowerCase().includes(ft));

        if (!filtered.length) {
          list.innerHTML = `<div class="cd-item" style="color:#6C757D">No matches</div>`;
          return;
        }

        filtered.forEach(o => {
          const id = `${containerId}_${o.value}`;
          const row = document.createElement('div');
          row.className = 'cd-item';
          row.innerHTML = `
            <label for="${id}">
              <input type="checkbox" id="${id}" value="${o.value}" ${selected.has(o.value) ? 'checked' : ''}/>
              <span>${o.label}</span>
            </label>
          `;
          const cb = row.querySelector('input');
          cb.addEventListener('change', () => {
            cb.checked ? selected.add(o.value) : selected.delete(o.value);
            updateSummary();
            updateSelectAllState();
            if (availableUsers.length > 0) {
              applyFilters();
              renderTable();
            }
          });
          list.appendChild(row);
        });
      }

      function updateSummary() {
        trigger.querySelector('.count').textContent = `${selected.size} selected`;
        summary.textContent = `${selected.size} selected`;
      }

      function updateSelectAllState() {
        const total = options.length;
        selectAll.indeterminate = selected.size > 0 && selected.size < total;
        selectAll.checked = total > 0 && selected.size === total;
      }

      trigger.addEventListener('click', () => { panel.classList.toggle('open'); search.focus(); });
      document.addEventListener('click', e => { if (!root.contains(e.target)) panel.classList.remove('open'); });
      search.addEventListener('input', () => render(search.value));

      clearBtn.addEventListener('click', () => {
        selected.clear();
        render(search.value);
        updateSummary();
        updateSelectAllState();
        if (availableUsers.length > 0) {
          applyFilters();
          renderTable();
        }
      });

      selectAll.addEventListener('change', () => {
        if (selectAll.checked) options.forEach(o => selected.add(o.value));
        else selected.clear();
        render(search.value);
        updateSummary();
        if (availableUsers.length > 0) {
          applyFilters();
          renderTable();
        }
      });

      function setOptions(arr) {
        options = arr || [];
        [...selected].forEach(v => { if (!options.some(o => o.value === v)) selected.delete(v) });
        render(search.value);
        updateSummary();
        updateSelectAllState();
      }

      function getSelectedValues() { return [...selected] }

      function setSelectedValues(vals) {
        selected = new Set(vals);
        render(search.value);
        updateSummary();
        updateSelectAllState();
      }

      render();

      return { setOptions, getSelectedValues, setSelectedValues };
    }

    function createDropdowns() {
      teamDropdown = createCheckboxDropdown('teamDropdown', {
        placeholder: 'Select teams',
        searchPlaceholder: 'Search teams...'
      });
      
      managementUnitDropdown = createCheckboxDropdown('managementUnitDropdown', {
        placeholder: 'Select management units',
        searchPlaceholder: 'Search management units...'
      });
    }

    function populateDropdownOptions() {
      const teamOpts = availableTeams
        .map(t => ({ value: t.id, label: t.name }))
        .sort((a, b) => a.label.localeCompare(b.label));
      teamDropdown.setOptions(teamOpts);

      const muOpts = availableManagementUnits
        .map(mu => ({ value: mu.id, label: mu.name }))
        .sort((a, b) => a.label.localeCompare(b.label));
      managementUnitDropdown.setOptions(muOpts);
    }

    function setupTabs() {
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          // Remove active class from all tabs and contents
          tabs.forEach(t => t.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));
          
          // Add active class to clicked tab and corresponding content
          tab.classList.add('active');
          const tabId = tab.dataset.tab;
          document.getElementById(tabId).classList.add('active');
        });
      });
    }

    async function findInactiveUsers() {
      if (availableUsers.length === 0) {
        showMessage('Please load users first', 'warning');
        return;
      }
      
      const daysSinceLogin = parseInt(document.getElementById('daysSinceLogin').value) || 30;
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;
      const teamFilter = document.getElementById('inactiveTeamFilter').value;
      
      let filteredInactive = availableUsers.filter(user => {
        // Filter by days since login
        if (user.daysSinceLastLogin < daysSinceLogin) {
          return false;
        }
        
        // Filter by date range if specified
        if (dateFrom && user.dateLastLogin) {
          const lastLogin = new Date(user.dateLastLogin);
          const fromDate = new Date(dateFrom);
          if (lastLogin < fromDate) {
            return false;
          }
        }
        
        if (dateTo && user.dateLastLogin) {
          const lastLogin = new Date(user.dateLastLogin);
          const toDate = new Date(dateTo);
          if (lastLogin > toDate) {
            return false;
          }
        }
        
        // Filter by team if specified
        if (teamFilter && user.team && user.team.id !== teamFilter) {
          return false;
        }
        
        return true;
      });
      
      // Sort by days since login (descending)
      filteredInactive.sort((a, b) => b.daysSinceLastLogin - a.daysSinceLastLogin);
      
      inactiveUsers = filteredInactive;
      renderInactiveUsersTable();
      updateInactiveStats();
      
      showMessage(`Found ${inactiveUsers.length} inactive users`, 'success');
    }

    async function renderInactiveUsersTable() {
      const tbody = document.querySelector('#inactiveUsersTable tbody');
      
      if (inactiveUsers.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-light)}">
          No inactive users found. Adjust your criteria and try again.
        </td></tr>`;
        return;
      }
      
      // Fetch queues for inactive users (limit to first 50 for performance)
      const usersToFetch = inactiveUsers.slice(0, 50);
      const queuePromises = usersToFetch.map(user => fetchUserQueues(user.id));
      const queuesList = await Promise.all(queuePromises);
      
      tbody.innerHTML = inactiveUsers.map((user, index) => {
        const status = user.routingStatus?.status || 'UNKNOWN';
        const presence = user.presence?.presenceDefinition?.systemPresence || 'Offline';
        const team = user.team?.name || 'Unassigned';
        const lastLogin = user.dateLastLogin ? 
          new Date(user.dateLastLogin).toLocaleDateString() + ' ' + 
          new Date(user.dateLastLogin).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) 
          : 'Never';
        const daysSinceLogin = user.daysSinceLastLogin || 0;
        const roles = user.roles || [];
        const userQueues = index < queuesList.length ? queuesList[index] : [];
        const skills = user.skills?.map(s => s.name) || [];
        const statusClass = getStatusClass(presence);
        
        let daysClass = '';
        if (daysSinceLogin > 30) daysClass = 'style="color: var(--danger); font-weight: bold;"';
        else if (daysSinceLogin > 7) daysClass = 'style="color: var(--warning);"';
        
        return `
          <tr>
            <td><strong>${user.name || 'Unknown'}</strong></td>
            <td>${user.email || 'No email'}</td>
            <td>
              <div class="roles-list" title="${roles.join(', ') || 'No role'}">
                ${roles.slice(0, 5).map(role => `<span>${role}</span>`).join('')}
                ${roles.length > 5 ? '<span>...</span>' : ''}
                ${roles.length === 0 ? '<span style="color: var(--text-light);">No role</span>' : ''}
              </div>
            </td>
            <td>${team}</td>
            <td>${lastLogin}</td>
            <td style="text-align:center;" ${daysClass}>${daysSinceLogin === 999 ? 'Never' : daysSinceLogin}</td>
            <td><span class="status-badge ${statusClass}">${presence}</span></td>
            <td>
              <div class="queues-list" title="${userQueues.join(', ')}">
                ${userQueues.slice(0, 5).map(queue => `<span>${queue}</span>`).join('')}
                ${userQueues.length > 5 ? '<span>...</span>' : ''}
                ${userQueues.length === 0 ? '<span style="color: var(--text-light);">None</span>' : ''}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function updateInactiveStats() {
      if (inactiveUsers.length === 0) {
        document.getElementById('totalInactiveUsers').textContent = '0';
        document.getElementById('avgDaysInactive').textContent = '0';
        document.getElementById('maxDaysInactive').textContent = '0';
        return;
      }
      
      const total = inactiveUsers.length;
      const avgDays = Math.round(inactiveUsers.reduce((sum, user) => sum + user.daysSinceLastLogin, 0) / total);
      const maxDays = Math.max(...inactiveUsers.map(user => user.daysSinceLastLogin));
      
      document.getElementById('totalInactiveUsers').textContent = total;
      document.getElementById('avgDaysInactive').textContent = avgDays;
      document.getElementById('maxDaysInactive').textContent = maxDays;
    }

    function setupEventListeners() {
      document.getElementById('fetchUsers').addEventListener('click', fetchUsers);
      
      document.getElementById('findInactiveUsers').addEventListener('click', findInactiveUsers);
      
      document.getElementById('refreshData').addEventListener('click', async () => {
        if (availableUsers.length === 0) {
          await fetchUsers();
        } else {
          applyFilters();
          renderTable();
        }
        showMessage('Data refreshed', 'success');
      });
      
      document.getElementById('exportCSV').addEventListener('click', exportToCSV);
      
      document.getElementById('exportInactiveCSV').addEventListener('click', exportInactiveToCSV);
      
      document.getElementById('clearFilters').addEventListener('click', clearFilters);
      
      document.getElementById('resetColumnWidths').addEventListener('click', resetColumnWidths);
      
      document.getElementById('resetInactiveColumnWidths').addEventListener('click', resetInactiveColumnWidths);
      
      document.getElementById('pageSize').addEventListener('change', function() {
        pageSize = parseInt(this.value);
        currentPage = 1;
        renderTable();
      });
      
      document.getElementById('prevPage').addEventListener('click', () => {
        currentPage--;
        renderTable();
      });
      
      document.getElementById('nextPage').addEventListener('click', () => {
        currentPage++;
        renderTable();
      });
      
      document.getElementById('globalSearch').addEventListener('input', function() {
        globalSearch = this.value;
        currentPage = 1;
        applyFilters();
        renderTable();
      });
      
      document.getElementById('statusFilter').addEventListener('change', function() {
        currentPage = 1;
        applyFilters();
        renderTable();
      });
      
      document.querySelectorAll('.column-filter').forEach(input => {
        input.addEventListener('input', function() {
          const column = this.dataset.column;
          if (this.value.trim()) {
            filters[column] = this.value;
          } else {
            delete filters[column];
          }
          currentPage = 1;
          applyFilters();
          renderTable();
        });
      });
      
      document.querySelectorAll('.sortable').forEach(th => {
        th.addEventListener('click', function() {
          const column = this.dataset.column;
          
          if (sortColumn === column) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
          } else {
            sortColumn = column;
            sortDirection = 'asc';
          }
          
          renderTable();
        });
      });
    }

    function exportToCSV() {
      if (filteredUsers.length === 0) {
        showMessage('No data to export', 'info');
        return;
      }
      
      const headers = [
        'Name', 'Email', 'Role', 'Status', 'Team', 'Presence',
        'Last Login', 'Days Since Login', 'Skills', 'Queues', 'User ID'
      ];
      
      const data = filteredUsers.map(user => [
        user.name || '',
        user.email || '',
        user.roles?.join('; ') || '',
        user.routingStatus?.status || '',
        user.team?.name || '',
        user.presence?.presenceDefinition?.systemPresence || '',
        user.dateLastLogin ? new Date(user.dateLastLogin).toISOString() : '',
        user.daysSinceLastLogin || 0,
        user.skills?.map(s => s.name).join('; ') || '',
        '', // Queues would need to be fetched separately for export
        user.id || ''
      ]);
      
      const csvContent = [
        headers.join(','),
        ...data.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
      ].join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `users_export_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      showMessage(`Exported ${filteredUsers.length} users to CSV`, 'success');
    }

    function exportInactiveToCSV() {
      if (inactiveUsers.length === 0) {
        showMessage('No inactive users to export', 'info');
        return;
      }
      
      const headers = [
        'Name', 'Email', 'Role', 'Team', 'Last Login', 
        'Days Since Login', 'Status', 'User ID'
      ];
      
      const data = inactiveUsers.map(user => [
        user.name || '',
        user.email || '',
        user.roles?.join('; ') || '',
        user.team?.name || '',
        user.dateLastLogin ? new Date(user.dateLastLogin).toISOString() : '',
        user.daysSinceLastLogin || 0,
        user.presence?.presenceDefinition?.systemPresence || '',
        user.id || ''
      ]);
      
      const csvContent = [
        headers.join(','),
        ...data.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
      ].join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `inactive_users_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      showMessage(`Exported ${inactiveUsers.length} inactive users to CSV`, 'success');
    }

    function clearFilters() {
      filters = {};
      globalSearch = '';
      document.getElementById('globalSearch').value = '';
      document.getElementById('statusFilter').value = '';
      teamDropdown.setSelectedValues([]);
      managementUnitDropdown.setSelectedValues([]);
      
      document.querySelectorAll('.column-filter').forEach(input => {
        input.value = '';
      });
      
      currentPage = 1;
      applyFilters();
      renderTable();
      showMessage('All filters cleared', 'success');
    }

    function showLoading(show) {
      document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }

    window.addEventListener('load', () => {
    });

  </script>
</body>
</html>
