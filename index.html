<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0; --filter-bg:#f0f7f3;
    }

    body{
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
      margin:20px;padding:20px;max-width:1800px;
      background:var(--light-bg);color:var(--text-color);
    }

    .card{
      background:var(--card-bg);
      border:1px solid var(--border-color);
      border-radius:12px;
      padding:24px;
      margin-top:16px;
      box-shadow:0 1px 3px rgba(0,0,0,.1);
    }

    label{display:block;font-weight:600;margin-bottom:6px}
    select,input,button{
      padding:10px;border:1px solid var(--border-color);
      border-radius:6px;background:var(--card-bg);font-size:14px
    }

    button{
      background:var(--primary-color);color:#fff;font-weight:600;
      cursor:pointer;transition:background .2s
    }
    button:hover{background:var(--secondary-color)}
    button:disabled{background:var(--text-light);cursor:not-allowed}

    .controls{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:16px;align-items:end
    }

    .full-width-btn{width:100%;padding:14px 18px;font-size:16px;margin-top:12px}
    .muted{color:var(--text-light);font-size:12px}
    .loading{opacity:.6;pointer-events:none}

    /* === FILTER CONTROLS === */
    .filter-section{
      margin-bottom:20px;
      padding:15px;
      border:1px solid var(--border-color);
      border-radius:8px;
      background-color:var(--light-bg);
    }
    .filter-section h3{
      margin-top:0;color:var(--primary-color);
    }

    /* === TABLE STYLING === */
    .table-container {
      overflow-x: auto;
      margin-top: 20px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1200px;
    }

    th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th, td {
      border: 1px solid var(--border-color);
      padding: 10px 12px;
      text-align: left;
      vertical-align: top;
      font-size: 13px;
    }

    tr:hover {
      background-color: var(--pill);
    }

    /* === SORTABLE HEADERS === */
    .sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
      padding-right: 24px !important;
    }

    .sortable:hover {
      background-color: var(--secondary-color);
    }

    .sortable::after {
      content: '↕';
      position: absolute;
      right: 8px;
      font-size: 12px;
      opacity: 0.7;
    }

    .sortable.asc::after {
      content: '↑';
      opacity: 1;
    }

    .sortable.desc::after {
      content: '↓';
      opacity: 1;
    }

    /* === COLUMN FILTERS === */
    .column-filter {
      display: block;
      width: 100%;
      padding: 6px 8px;
      margin-top: 4px;
      font-size: 12px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: var(--filter-bg);
    }

    .column-filter:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(99, 171, 143, 0.2);
    }

    /* === STATUS BADGES === */
    .status-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-online { background: #d4edda; color: #155724; }
    .status-offline { background: #f8d7da; color: #721c24; }
    .status-away { background: #fff3cd; color: #856404; }
    .status-busy { background: #d1ecf1; color: #0c5460; }

    /* === ACTION BUTTONS === */
    .action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .action-btn {
      padding: 8px 12px;
      font-size: 12px;
      border-radius: 4px;
    }

    .export-btn {
      background: #6c757d;
      margin-left: auto;
    }

    .export-btn:hover {
      background: #5a6268;
    }

    /* === CHECKBOX DROPDOWN === */
    .checkbox-dropdown{
      position:relative;min-width:240px;width:100%
    }
    .cd-trigger{
      display:flex;align-items:center;justify-content:space-between;
      border:1px solid var(--border-color);border-radius:6px;
      background:#fff;padding:10px;cursor:pointer;width:100%;
    }
    .cd-trigger .label{color:var(--text-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
    .cd-trigger .count{
      background:var(--pill);border:1px solid var(--border-color);
      border-radius:999px;padding:2px 8px;font-size:12px;
      color:#2c3e50;flex-shrink:0;margin-left:8px
    }

    .cd-panel{
      position:absolute;z-index:1000;margin-top:6px;background:#fff;
      border:1px solid var(--border-color);border-radius:8px;
      box-shadow:0 8px 24px rgba(0,0,0,.12);width:100%;
      max-height:340px;overflow:hidden;display:none
    }
    .cd-panel.open{display:block}

    .cd-header{
      padding:10px;border-bottom:1px solid var(--border-color);
      display:flex;gap:8px;align-items:center
    }
    .cd-search{
      flex:1;border:1px solid var(--border-color);border-radius:6px;
      padding:8px;width:100%;box-sizing:border-box
    }
    .cd-actions button{
      background:#eef6f2;color:#2c3e50;border:1px solid var(--border-color);
      border-radius:6px;padding:8px 10px;cursor:pointer;
    }

    .cd-selectall{
      padding:8px 12px;border-bottom:1px solid var(--border-color);
      display:flex;align-items:center;gap:10px
    }

    .cd-list{max-height:260px;overflow:auto}
    .cd-item{
      display:flex;align-items:center;gap:10px;
      padding:8px 12px;border-bottom:1px solid #f1f3f5
    }

    .cd-footer{
      padding:8px 12px;background:#fafafa;border-top:1px solid var(--border-color);
      font-size:12px;color:var(--text-light);display:flex;justify-content:space-between
    }

    /* === STATS BAR === */
    .stats-bar {
      display: flex;
      gap: 20px;
      padding: 12px 16px;
      background: var(--filter-bg);
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 14px;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
    }

    .stat-value {
      font-weight: 700;
      font-size: 18px;
      color: var(--primary-color);
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-light);
    }

    /* === RESPONSIVE === */
    @media (max-width: 1200px) {
      .controls {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }
    }

    @media (max-width: 768px) {
      body {
        margin: 10px;
        padding: 10px;
      }
      
      .controls {
        grid-template-columns: 1fr;
      }
      
      .stats-bar {
        flex-wrap: wrap;
        gap: 10px;
      }
    }

    .error-message{
      color:#d9534f;padding:10px;margin:10px 0;
      border:1px solid #d9534f;border-radius:4px;background:#f9f2f2;
    }
    .success-message{
      color:#3c763d;padding:10px;margin:10px 0;
      border:1px solid #3c763d;border-radius:4px;background:#dff0d8;
    }
  </style>
</head>
<body>

  <div id="loginSection" class="card" style="text-align:center;margin:20px;">
    <div class="loading">Authenticating with PureCloud...</div>
  </div>

  <div id="appContent" style="display:none;">
    <div id="messageContainer" style="display:none;"></div>

    <h1 style="margin-bottom: 20px;">User Management Dashboard</h1>

    <div class="filter-section card">
      <h3>Filter Users</h3>
      
      <div class="controls">
        <div>
          <label>Select Management Units</label>
          <div id="managementUnitDropdown" class="checkbox-dropdown"></div>
        </div>
        <div>
          <label>Select Teams</label>
          <div id="teamDropdown" class="checkbox-dropdown"></div>
        </div>
        <div>
          <label>Filter by Status</label>
          <select id="statusFilter">
            <option value="">All Statuses</option>
            <option value="ONLINE">Online</option>
            <option value="OFFLINE">Offline</option>
            <option value="AWAY">Away</option>
            <option value="BUSY">Busy</option>
          </select>
        </div>
        <div>
          <label>Search Users</label>
          <input type="text" id="globalSearch" placeholder="Search name, email, skills..." />
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="fetchUsers" class="full-width-btn">Load Users</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="action-buttons">
        <button id="refreshData" class="action-btn">Refresh Data</button>
        <button id="exportCSV" class="action-btn export-btn">Export to CSV</button>
        <select id="pageSize" style="margin-left: auto; width: auto;">
          <option value="25">25 per page</option>
          <option value="50" selected>50 per page</option>
          <option value="100">100 per page</option>
          <option value="200">200 per page</option>
        </select>
      </div>

      <div class="stats-bar" id="statsBar">
        <div class="stat-item">
          <span class="stat-value" id="totalUsers">0</span>
          <span class="stat-label">Total Users</span>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="onlineUsers">0</span>
          <span class="stat-label">Online</span>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="activeUsers">0</span>
          <span class="stat-label">Active Today</span>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="awayUsers">0</span>
          <span class="stat-label">Away</span>
        </div>
      </div>

      <div class="table-container">
        <table id="usersTable">
          <thead>
            <tr>
              <th class="sortable" data-column="name">Name</th>
              <th class="sortable" data-column="routingStatus.status">Status</th>
              <th class="sortable" data-column="email">Email</th>
              <th class="sortable" data-column="routingStatus.queues">Queues</th>
              <th class="sortable" data-column="team.name">Team</th>
              <th class="sortable" data-column="presence.presenceDefinition.systemPresence">Presence</th>
              <th class="sortable" data-column="lastLogin">Last Login</th>
              <th class="sortable" data-column="skills">Skills</th>
              <th>Actions</th>
            </tr>
            <tr class="filter-row">
              <td><input type="text" class="column-filter" data-column="name" placeholder="Filter name..."></td>
              <td><select class="column-filter" data-column="routingStatus.status">
                <option value="">All</option>
                <option value="IDLE">Idle</option>
                <option value="INTERACTING">Interacting</option>
                <option value="NOT_RESPONDING">Not Responding</option>
              </select></td>
              <td><input type="text" class="column-filter" data-column="email" placeholder="Filter email..."></td>
              <td><input type="text" class="column-filter" data-column="routingStatus.queues" placeholder="Filter queues..."></td>
              <td><input type="text" class="column-filter" data-column="team.name" placeholder="Filter team..."></td>
              <td><select class="column-filter" data-column="presence.presenceDefinition.systemPresence">
                <option value="">All</option>
                <option value="Available">Available</option>
                <option value="Busy">Busy</option>
                <option value="Away">Away</option>
                <option value="Offline">Offline</option>
              </select></td>
              <td><input type="text" class="column-filter" data-column="lastLogin" placeholder="Filter date..."></td>
              <td><input type="text" class="column-filter" data-column="skills" placeholder="Filter skills..."></td>
              <td><button onclick="clearFilters()" style="font-size:12px;padding:6px 10px;">Clear Filters</button></td>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
        <div id="paginationInfo" class="muted"></div>
        <div>
          <button id="prevPage" class="action-btn" disabled>Previous</button>
          <button id="nextPage" class="action-btn" disabled>Next</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /********* OAuth + Global Vars *********/
    const clientId = 'fe305808-b368-4547-8af9-325d28d552bb';
    const redirectUri = 'https://gmcglynn88.github.io/profiles/';
    const oauthUrl =
      `https://login.mypurecloud.ie/oauth/authorize?client_id=${clientId}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}`;

    let token = null;
    let availableUsers = [];
    let availableTeams = [];
    let availableManagementUnits = [];

    // Table state
    let currentPage = 1;
    let pageSize = 50;
    let sortColumn = 'name';
    let sortDirection = 'asc';
    let filters = {};
    let globalSearch = '';
    let filteredUsers = [];

    document.addEventListener('DOMContentLoaded', () => {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      token = params.get("access_token");

      if (!token) {
        window.location.href = oauthUrl;
        return;
      }

      document.getElementById("loginSection").style.display = "none";
      document.getElementById("appContent").style.display = "block";

      initializeApp(token);
    });

    function showMessage(message, type='error'){
      const msgBox = document.getElementById('messageContainer');
      msgBox.innerHTML = `<div class="${type}-message">${message}</div>`;
      msgBox.style.display = 'block';
      if (type === 'success') setTimeout(() => (msgBox.style.display='none'), 5000);
    }

    function authHeaders(){
      return { Authorization:`Bearer ${token}`, "Content-Type":"application/json" };
    }

    /********* INITIAL LOAD *********/
    async function initializeApp(){
      try {
        await Promise.all([
          fetchAllTeams(),
          fetchAllManagementUnits()
        ]);

        createDropdowns();
        populateDropdownOptions();
        setupEventListeners();

        // Load initial data
        await fetchUsers();

      } catch (e){
        console.error(e);
        showMessage("Error initialising. Redirecting...");
        setTimeout(()=> window.location.href = oauthUrl, 2000);
      }
    }

    /********* DATA LOADERS *********/
    async function fetchAllTeams(){
      let all=[], page=1, size=100, total=0;
      do{
        const res = await fetch(
          `https://api.mypurecloud.ie/api/v2/teams?pageNumber=${page}&pageSize=${size}`,
          {headers:authHeaders()}
        );
        const data = await res.json();
        all = all.concat(data.entities||[]);
        total = data.total||0; page++;
      } while(all.length < total);
      availableTeams = all;
    }

    async function fetchAllManagementUnits(){
      let all=[], page=1, size=100, total=0;
      do{
        const res = await fetch(
          `https://api.mypurecloud.ie/api/v2/workforcemanagement/managementunits?pageNumber=${page}&pageSize=${size}`,
          {headers:authHeaders()}
        );
        const data = await res.json();
        all = all.concat(data.entities||[]);
        total = data.total||0; page++;
      } while(all.length < total);
      availableManagementUnits = all;
    }

    async function fetchUsers(){
      try {
        document.getElementById('fetchUsers').disabled = true;
        document.getElementById('fetchUsers').textContent = 'Loading...';
        
        const expandFields = [
          'routingStatus',
          'presence',
          'integrationPresence',
          'conversationSummary',
          'outOfOffice',
          'geolocation',
          'station',
          'authorization',
          'lasttokenissued',
          'authorization.unusedRoles',
          'team',
          'workPlanBidRanks',
          'externalContactsSettings',
          'groups',
          'customAttributes',
          'profileSkills',
          'certifications',
          'skills',
          'languages',
          'languagePreference',
          'employerInfo',
          'biography',
          'dateLastLogin',
          'dateWelcomeSent'
        ].join(',');

        let allUsers = [];
        let page = 1;
        const size = 100;
        let total = 0;

        do {
          const res = await fetch(
            `https://api.mypurecloud.ie/api/v2/users?expand=${expandFields}&pageNumber=${page}&pageSize=${size}`,
            {headers:authHeaders()}
          );
          
          if (!res.ok) throw new Error(`API error: ${res.status}`);
          
          const data = await res.json();
          allUsers = allUsers.concat(data.entities||[]);
          total = data.total||0;
          page++;
          
          // Update progress
          const tbody = document.querySelector('#usersTable tbody');
          tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:20px;">
            Loading... ${Math.min(allUsers.length, total)} of ${total} users
          </td></tr>`;
          
        } while(allUsers.length < total);

        availableUsers = allUsers.filter(u => u.name && u.name.trim() && u.name !== 'Unknown User');
        
        // Apply initial filters and render
        applyFilters();
        renderTable();
        
        showMessage(`Successfully loaded ${availableUsers.length} users`, 'success');
        
      } catch (error) {
        console.error('Error fetching users:', error);
        showMessage(`Error loading users: ${error.message}`);
      } finally {
        document.getElementById('fetchUsers').disabled = false;
        document.getElementById('fetchUsers').textContent = 'Load Users';
      }
    }

    /********* FILTERING LOGIC *********/
    function applyFilters() {
      filteredUsers = [...availableUsers];
      
      // Apply global search
      if (globalSearch) {
        const search = globalSearch.toLowerCase();
        filteredUsers = filteredUsers.filter(user => {
          return (
            (user.name && user.name.toLowerCase().includes(search)) ||
            (user.email && user.email.toLowerCase().includes(search)) ||
            (user.skills && user.skills.some(skill => 
              skill.name && skill.name.toLowerCase().includes(search)
            )) ||
            (user.team && user.team.name && user.team.name.toLowerCase().includes(search))
          );
        });
      }
      
      // Apply column filters
      Object.keys(filters).forEach(column => {
        const filterValue = filters[column].toLowerCase();
        if (!filterValue) return;
        
        filteredUsers = filteredUsers.filter(user => {
          const value = getNestedValue(user, column);
          
          if (value === undefined || value === null) return false;
          
          if (Array.isArray(value)) {
            return value.some(item => 
              String(item).toLowerCase().includes(filterValue)
            );
          }
          
          return String(value).toLowerCase().includes(filterValue);
        });
      });
      
      // Apply status filter
      const statusFilter = document.getElementById('statusFilter').value;
      if (statusFilter) {
        filteredUsers = filteredUsers.filter(user => 
          user.presence && 
          user.presence.presenceDefinition && 
          user.presence.presenceDefinition.systemPresence === statusFilter
        );
      }
      
      // Apply team filter
      const selectedTeams = teamDropdown.getSelectedValues();
      if (selectedTeams.length > 0) {
        filteredUsers = filteredUsers.filter(user => 
          user.team && selectedTeams.includes(user.team.id)
        );
      }
      
      // Apply management unit filter
      const selectedMUs = managementUnitDropdown.getSelectedValues();
      if (selectedMUs.length > 0) {
        // Note: Management unit filtering requires additional API calls
        // This is a simplified implementation
      }
      
      updateStats();
    }

    function getNestedValue(obj, path) {
      return path.split('.').reduce((current, key) => {
        return current ? current[key] : undefined;
      }, obj);
    }

    /********* SORTING LOGIC *********/
    function sortUsers(users) {
      return users.sort((a, b) => {
        let valA = getNestedValue(a, sortColumn);
        let valB = getNestedValue(b, sortColumn);
        
        // Handle arrays (like skills)
        if (Array.isArray(valA)) {
          valA = valA.map(v => v.name || v).join(', ');
        }
        if (Array.isArray(valB)) {
          valB = valB.map(v => v.name || v).join(', ');
        }
        
        // Handle dates
        if (sortColumn.includes('date') || sortColumn.includes('Date') || sortColumn.includes('lastLogin')) {
          valA = valA ? new Date(valA).getTime() : 0;
          valB = valB ? new Date(valB).getTime() : 0;
        }
        
        // Convert to string for comparison
        valA = String(valA || '').toLowerCase();
        valB = String(valB || '').toLowerCase();
        
        if (sortDirection === 'asc') {
          return valA.localeCompare(valB);
        } else {
          return valB.localeCompare(valA);
        }
      });
    }

    /********* RENDER TABLE *********/
    function renderTable() {
      const tbody = document.querySelector('#usersTable tbody');
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageUsers = sortUsers([...filteredUsers]).slice(start, end);
      
      if (pageUsers.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text-light)">
          No users found. Try adjusting your filters.
        </td></tr>`;
        return;
      }
      
      tbody.innerHTML = pageUsers.map(user => {
        const status = user.routingStatus?.status || 'UNKNOWN';
        const presence = user.presence?.presenceDefinition?.systemPresence || 'Offline';
        const queues = user.routingStatus?.queues?.map(q => q.name).join(', ') || 'None';
        const team = user.team?.name || 'Unassigned';
        const lastLogin = user.dateLastLogin ? new Date(user.dateLastLogin).toLocaleDateString() : 'Never';
        const skills = user.skills?.map(s => s.name).join(', ') || 'None';
        
        // Determine status badge class
        let statusClass = 'status-offline';
        if (presence === 'Available') statusClass = 'status-online';
        else if (presence === 'Busy') statusClass = 'status-busy';
        else if (presence === 'Away') statusClass = 'status-away';
        
        return `
          <tr>
            <td>
              <strong>${user.name || 'Unknown'}</strong><br>
              <small class="muted">${user.id || ''}</small>
            </td>
            <td>
              <span class="status-badge ${statusClass}">${presence}</span><br>
              <small class="muted">${status}</small>
            </td>
            <td>${user.email || 'No email'}</td>
            <td>${queues}</td>
            <td>${team}</td>
            <td>${presence}</td>
            <td>${lastLogin}</td>
            <td>${skills}</td>
            <td>
              <button onclick="viewUserDetails('${user.id}')" style="font-size:12px;padding:4px 8px;margin-bottom:4px;">
                View Details
              </button>
            </td>
          </tr>
        `;
      }).join('');
      
      // Update pagination info
      document.getElementById('paginationInfo').textContent = 
        `Showing ${start + 1}-${Math.min(end, filteredUsers.length)} of ${filteredUsers.length} users`;
      
      // Update pagination buttons
      document.getElementById('prevPage').disabled = currentPage === 1;
      document.getElementById('nextPage').disabled = end >= filteredUsers.length;
      
      // Update sort indicators
      updateSortIndicators();
    }

    function updateSortIndicators() {
      document.querySelectorAll('.sortable').forEach(th => {
        th.classList.remove('asc', 'desc');
        if (th.dataset.column === sortColumn) {
          th.classList.add(sortDirection);
        }
      });
    }

    /********* STATS UPDATE *********/
    function updateStats() {
      const total = filteredUsers.length;
      const online = filteredUsers.filter(u => 
        u.presence?.presenceDefinition?.systemPresence === 'Available'
      ).length;
      const active = filteredUsers.filter(u => {
        if (!u.dateLastLogin) return false;
        const lastLogin = new Date(u.dateLastLogin);
        const today = new Date();
        return lastLogin.toDateString() === today.toDateString();
      }).length;
      const away = filteredUsers.filter(u => 
        u.presence?.presenceDefinition?.systemPresence === 'Away'
      ).length;
      
      document.getElementById('totalUsers').textContent = total;
      document.getElementById('onlineUsers').textContent = online;
      document.getElementById('activeUsers').textContent = active;
      document.getElementById('awayUsers').textContent = away;
    }

    /********* CHECKBOX DROPDOWNS *********/
    let teamDropdown, managementUnitDropdown;

    function createCheckboxDropdown(containerId, {placeholder, searchPlaceholder}) {
      const root = document.getElementById(containerId);
      root.innerHTML = '';

      const trigger = document.createElement('div');
      trigger.className = 'cd-trigger';
      trigger.innerHTML = `<span class="label">${placeholder}</span><span class="count">0 selected</span>`;
      root.appendChild(trigger);

      const panel = document.createElement('div');
      panel.className = 'cd-panel';
      panel.innerHTML = `
        <div class="cd-header">
          <input type="text" class="cd-search" placeholder="${searchPlaceholder}" />
          <div class="cd-actions"><button data-cd="clear">Clear</button></div>
        </div>
        <div class="cd-selectall"><label><input type="checkbox" data-cd="selectall"/> Select all</label></div>
        <div class="cd-list"></div>
        <div class="cd-footer"><span data-cd="summary">0 selected</span><span>Click outside to close</span></div>
      `;
      root.appendChild(panel);

      const list = panel.querySelector('.cd-list');
      const search = panel.querySelector('.cd-search');
      const clearBtn = panel.querySelector('[data-cd="clear"]');
      const selectAll = panel.querySelector('[data-cd="selectall"]');
      const summary = panel.querySelector('[data-cd="summary"]');

      let options = [], selected = new Set();

      function render(filter = '') {
        const ft = filter.toLowerCase().trim();
        list.innerHTML = '';
        const filtered = !ft ? options : options.filter(o => (o.label || '').toLowerCase().includes(ft));

        if (!filtered.length) {
          list.innerHTML = `<div class="cd-item" style="color:#6C757D">No matches</div>`;
          return;
        }

        filtered.forEach(o => {
          const id = `${containerId}_${o.value}`;
          const row = document.createElement('div');
          row.className = 'cd-item';
          row.innerHTML = `
            <label for="${id}">
              <input type="checkbox" id="${id}" value="${o.value}" ${selected.has(o.value) ? 'checked' : ''}/>
              <span>${o.label}</span>
            </label>
          `;
          const cb = row.querySelector('input');
          cb.addEventListener('change', () => {
            cb.checked ? selected.add(o.value) : selected.delete(o.value);
            updateSummary();
            updateSelectAllState();
          });
          list.appendChild(row);
        });
      }

      function updateSummary() {
        trigger.querySelector('.count').textContent = `${selected.size} selected`;
        summary.textContent = `${selected.size} selected`;
      }

      function updateSelectAllState() {
        const total = options.length;
        selectAll.indeterminate = selected.size > 0 && selected.size < total;
        selectAll.checked = total > 0 && selected.size === total;
      }

      trigger.addEventListener('click', () => { panel.classList.toggle('open'); search.focus(); });
      document.addEventListener('click', e => { if (!root.contains(e.target)) panel.classList.remove('open'); });
      search.addEventListener('input', () => render(search.value));

      clearBtn.addEventListener('click', () => {
        selected.clear();
        render(search.value);
        updateSummary();
        updateSelectAllState();
      });

      selectAll.addEventListener('change', () => {
        if (selectAll.checked) options.forEach(o => selected.add(o.value));
        else selected.clear();
        render(search.value);
        updateSummary();
      });

      function setOptions(arr) {
        options = arr || [];
        [...selected].forEach(v => { if (!options.some(o => o.value === v)) selected.delete(v) });
        render(search.value);
        updateSummary();
        updateSelectAllState();
      }

      function getSelectedValues() { return [...selected] }

      function setSelectedValues(vals) {
        selected = new Set(vals);
        render(search.value);
        updateSummary();
        updateSelectAllState();
      }

      render();

      return { setOptions, getSelectedValues, setSelectedValues };
    }

    function createDropdowns() {
      teamDropdown = createCheckboxDropdown('teamDropdown', {
        placeholder: 'Select teams',
        searchPlaceholder: 'Search teams...'
      });
      
      managementUnitDropdown = createCheckboxDropdown('managementUnitDropdown', {
        placeholder: 'Select management units',
        searchPlaceholder: 'Search management units...'
      });
    }

    function populateDropdownOptions() {
      const teamOpts = availableTeams
        .map(t => ({ value: t.id, label: t.name }))
        .sort((a, b) => a.label.localeCompare(b.label));
      teamDropdown.setOptions(teamOpts);

      const muOpts = availableManagementUnits
        .map(mu => ({ value: mu.id, label: mu.name }))
        .sort((a, b) => a.label.localeCompare(b.label));
      managementUnitDropdown.setOptions(muOpts);
    }

    /********* EVENT LISTENERS *********/
    function setupEventListeners() {
      // Load users button
      document.getElementById('fetchUsers').addEventListener('click', fetchUsers);
      
      // Refresh button
      document.getElementById('refreshData').addEventListener('click', async () => {
        await fetchUsers();
        showMessage('Data refreshed', 'success');
      });
      
      // Export CSV
      document.getElementById('exportCSV').addEventListener('click', exportToCSV);
      
      // Page size
      document.getElementById('pageSize').addEventListener('change', function() {
        pageSize = parseInt(this.value);
        currentPage = 1;
        renderTable();
      });
      
      // Pagination
      document.getElementById('prevPage').addEventListener('click', () => {
        currentPage--;
        renderTable();
      });
      
      document.getElementById('nextPage').addEventListener('click', () => {
        currentPage++;
        renderTable();
      });
      
      // Global search
      document.getElementById('globalSearch').addEventListener('input', function() {
        globalSearch = this.value;
        currentPage = 1;
        applyFilters();
        renderTable();
      });
      
      // Status filter
      document.getElementById('statusFilter').addEventListener('change', function() {
        currentPage = 1;
        applyFilters();
        renderTable();
      });
      
      // Team filter changes
      teamDropdown.setOptions = function(arr) {
        this._setOptions(arr);
        currentPage = 1;
        applyFilters();
        renderTable();
      };
      
      // Column filters
      document.querySelectorAll('.column-filter').forEach(input => {
        input.addEventListener('input', function() {
          const column = this.dataset.column;
          if (this.value.trim()) {
            filters[column] = this.value;
          } else {
            delete filters[column];
          }
          currentPage = 1;
          applyFilters();
          renderTable();
        });
      });
      
      // Sortable headers
      document.querySelectorAll('.sortable').forEach(th => {
        th.addEventListener('click', function() {
          const column = this.dataset.column;
          
          if (sortColumn === column) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
          } else {
            sortColumn = column;
            sortDirection = 'asc';
          }
          
          renderTable();
        });
      });
    }

    /********* EXPORT CSV *********/
    function exportToCSV() {
      const headers = [
        'Name', 'Status', 'Email', 'Queues', 'Team', 
        'Presence', 'Last Login', 'Skills', 'ID'
      ];
      
      const data = filteredUsers.map(user => [
        user.name || '',
        user.routingStatus?.status || '',
        user.email || '',
        user.routingStatus?.queues?.map(q => q.name).join('; ') || '',
        user.team?.name || '',
        user.presence?.presenceDefinition?.systemPresence || '',
        user.dateLastLogin ? new Date(user.dateLastLogin).toLocaleDateString() : '',
        user.skills?.map(s => s.name).join('; ') || '',
        user.id || ''
      ]);
      
      const csvContent = [
        headers.join(','),
        ...data.map(row => row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(','))
      ].join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `users_export_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      
      showMessage('CSV exported successfully', 'success');
    }

    /********* UTILITY FUNCTIONS *********/
    function clearFilters() {
      filters = {};
      globalSearch = '';
      document.getElementById('globalSearch').value = '';
      document.getElementById('statusFilter').value = '';
      teamDropdown.setSelectedValues([]);
      managementUnitDropdown.setSelectedValues([]);
      
      document.querySelectorAll('.column-filter').forEach(input => {
        input.value = '';
      });
      
      currentPage = 1;
      applyFilters();
      renderTable();
      showMessage('All filters cleared', 'success');
    }

    function viewUserDetails(userId) {
      const user = availableUsers.find(u => u.id === userId);
      if (!user) return;
      
      const details = JSON.stringify(user, null, 2);
      const win = window.open('', '_blank');
      win.document.write(`<pre>${details}</pre>`);
    }

    // Handle window resize
    window.addEventListener('resize', () => {
      // Adjust table responsiveness if needed
    });

  </script>
</body>
</html>
