<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0; --filter-bg:#f0f7f3; --warning:#ffc107; --danger:#dc3545;
      
      /* New status colors */
      --status-onqueue: #b3e0ff; /* Pastel Blue */
      --status-offqueue: #d2b48c; /* Brown/Tan */
      --status-available: #c3e6cb; /* Green */
      --status-offline: #e2e3e5; /* Grey */
      --status-unavailable: #d6d8db; /* Darker Grey */
      --status-busy: #f5c6cb; /* Red */
      --status-meetings: #f8d7da; /* Red */
      --status-breaks: #ffeaa7; /* Orange/Yellow */
      --status-meal: #ffcc99; /* Orange */
      --status-away: #ffc107; /* Orange */
      --status-training: #c3e6cb; /* Green */
      
      /* Text colors for statuses */
      --status-onqueue-text: #0066cc;
      --status-offqueue-text: #8b4513;
      --status-available-text: #155724;
      --status-offline-text: #383d41;
      --status-unavailable-text: #383d41;
      --status-busy-text: #721c24;
      --status-meetings-text: #721c24;
      --status-breaks-text: #856404;
      --status-meal-text: #856404;
      --status-away-text: #856404;
      --status-training-text: #155724;
    }

    body{
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
      margin:20px;padding:20px;max-width:1800px;
      background:var(--light-bg);color:var(--text-color);
    }

    .card{
      background:var(--card-bg);
      border:1px solid var(--border-color);
      border-radius:12px;
      padding:24px;
      margin-top:16px;
      box-shadow:0 1px 3px rgba(0,0,0,.1);
    }

    label{display:block;font-weight:600;margin-bottom:6px}
    select,input,button{
      padding:10px;border:1px solid var(--border-color);
      border-radius:6px;background:var(--card-bg);font-size:14px
    }

    button{
      background:var(--primary-color);color:#fff;font-weight:600;
      cursor:pointer;transition:background .2s
    }
    button:hover{background:var(--secondary-color)}
    button:disabled{background:var(--text-light);cursor:not-allowed}

    .controls{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:16px;
      align-items:end;
    }

    .full-width-btn{width:100%;padding:14px 18px;font-size:16px;margin-top:12px}
    .muted{color:var(--text-light);font-size:12px}
    .loading{opacity:.6;pointer-events:none}

    .filter-section{
      margin-bottom:20px;
      padding:15px;
      border:1px solid var(--border-color);
      border-radius:8px;
      background-color:var(--light-bg);
    }
    .filter-section h3{
      margin-top:0;color:var(--primary-color);
    }

    .table-container {
      overflow-x: auto;
      margin-top: 20px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      position: relative;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
      position: relative;
      user-select: none;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 80px;
    }

    th, td {
      border: 1px solid var(--border-color);
      padding: 10px 12px;
      text-align: left;
      vertical-align: top;
      font-size: 13px;
    }

    tr:hover {
      background-color: var(--pill);
    }

    .sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
      padding-right: 24px !important;
    }

    .sortable:hover {
      background-color: var(--secondary-color);
    }

    .sortable::after {
      content: 'â†•';
      position: absolute;
      right: 8px;
      font-size: 12px;
      opacity: 0.7;
    }

    .sortable.asc::after {
      content: 'â†‘';
      opacity: 1;
    }

    .sortable.desc::after {
      content: 'â†“';
      opacity: 1;
    }

    .column-filter {
      display: block;
      width: 100%;
      padding: 6px 8px;
      margin-top: 4px;
      font-size: 12px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: var(--filter-bg);
      box-sizing: border-box;
    }

    .column-filter:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(99, 171, 143, 0.2);
    }

    .filter-row th, .filter-row td {
      padding: 4px 6px !important;
      background-color: var(--filter-bg);
    }

    .filter-row input, .filter-row select {
      width: 100%;
      box-sizing: border-box;
    }

    .status-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-onqueue { background: var(--status-onqueue); color: var(--status-onqueue-text); }
    .status-offqueue { background: var(--status-offqueue); color: var(--status-offqueue-text); }
    .status-available { background: var(--status-available); color: var(--status-available-text); }
    .status-offline { background: var(--status-offline); color: var(--status-offline-text); }
    .status-unavailable { background: var(--status-unavailable); color: var(--status-unavailable-text); }
    .status-busy { background: var(--status-busy); color: var(--status-busy-text); }
    .status-meetings { background: var(--status-meetings); color: var(--status-meetings-text); }
    .status-breaks { background: var(--status-breaks); color: var(--status-breaks-text); }
    .status-meal { background: var(--status-meal); color: var(--status-meal-text); }
    .status-away { background: var(--status-away); color: var(--status-away-text); }
    .status-training { background: var(--status-training); color: var(--status-training-text); }
    .status-idle { background: var(--status-offline); color: var(--status-offline-text); }

    .action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 8px 12px;
      font-size: 12px;
      border-radius: 4px;
    }

    .export-btn {
      background: #6c757d;
    }

    .export-btn:hover {
      background: #5a6268;
    }

    .checkbox-dropdown{
      position:relative;
      width:100%
    }
    .cd-trigger{
      display:flex;align-items:center;justify-content:space-between;
      border:1px solid var(--border-color);border-radius:6px;
      background:#fff;padding:10px;cursor:pointer;width:100%;
      min-height: 42px;
      box-sizing: border-box;
    }
    .cd-trigger .label{color:var(--text-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
    .cd-trigger .count{
      background:var(--pill);border:1px solid var(--border-color);
      border-radius:999px;padding:2px 8px;font-size:12px;
      color:#2c3e50;flex-shrink:0;margin-left:8px
    }

    .cd-panel{
      position:absolute;z-index:1000;margin-top:6px;background:#fff;
      border:1px solid var(--border-color);border-radius:8px;
      box-shadow:0 8px 24px rgba(0,0,0,.12);width:100%;
      max-height:340px;overflow:hidden;display:none
    }
    .cd-panel.open{display:block}

    .cd-header{
      padding:10px;border-bottom:1px solid var(--border-color);
      display:flex;gap:8px;align-items:center
    }
    .cd-search{
      flex:1;border:1px solid var(--border-color);border-radius:6px;
      padding:8px;width:100%;box-sizing:border-box
    }
    .cd-actions button{
      background:#eef6f2;color:#2c3e50;border:1px solid var(--border-color);
      border-radius:6px;padding:8px 10px;cursor:pointer;
    }

    .cd-selectall{
      padding:8px 12px;border-bottom:1px solid var(--border-color);
      display:flex;align-items:center;gap:10px
    }

    .cd-list{max-height:260px;overflow:auto}
    .cd-item{
      display:flex;align-items:center;gap:10px;
      padding:8px 12px;border-bottom:1px solid #f1f3f5
    }

    .cd-footer{
      padding:8px 12px;background:#fafafa;border-top:1px solid var(--border-color);
      font-size:12px;color:var(--text-light);display:flex;justify-content:space-between
    }

    .stats-bar {
      display: flex;
      gap: 20px;
      padding: 12px 16px;
      background: var(--filter-bg);
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 14px;
      flex-wrap: wrap;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      min-width: 80px;
    }

    .stat-value {
      font-weight: 700;
      font-size: 18px;
      color: var(--primary-color);
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-light);
    }

    .progress-container {
      margin: 20px 0;
      background: var(--light-bg);
      border-radius: 8px;
      padding: 15px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--border-color);
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: var(--primary-color);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .progress-text {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-light);
    }

    .rate-limit-info {
      background: var(--warning);
      color: #856404;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      margin-top: 8px;
      display: none;
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .tab {
      padding: 12px 24px;
      cursor: pointer;
      border: none;
      background: none;
      font-weight: 600;
      color: var(--text-light);
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .tab.active {
      color: var(--primary-color);
      border-bottom: 3px solid var(--primary-color);
    }

    .tab:hover {
      color: var(--primary-color);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .inactive-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
      padding: 15px;
      background: var(--filter-bg);
      border-radius: 8px;
    }

    .roles-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
      padding: 15px;
      background: var(--filter-bg);
      border-radius: 8px;
    }

    .days-input {
      width: 100px;
    }

    .date-range-inputs {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .date-range-inputs input {
      flex: 1;
    }

    .roles-list, .skills-list, .queues-list {
      max-height: 100px;
      overflow-y: auto;
      padding: 5px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: var(--light-bg);
    }

    .roles-list span, .skills-list span, .queues-list span {
      display: inline-block;
      background: var(--pill);
      padding: 2px 6px;
      margin: 2px;
      border-radius: 3px;
      font-size: 11px;
      white-space: normal;
      word-break: break-word;
      max-width: 100%;
    }

    .role-card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.2s;
    }

    .role-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }

    .role-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .role-name {
      font-weight: 600;
      font-size: 16px;
      color: var(--primary-color);
    }

    .role-count {
      background: var(--primary-color);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 14px;
    }

    .role-users {
      margin-top: 10px;
      font-size: 13px;
      color: var(--text-light);
    }

    .role-users span {
      display: inline-block;
      background: var(--pill);
      padding: 4px 8px;
      margin: 2px;
      border-radius: 4px;
      font-size: 12px;
    }

    .role-actions {
      margin-top: 12px;
      display: flex;
      gap: 8px;
    }

    .role-actions button {
      flex: 1;
    }

    .resizer {
      position: absolute;
      right: 0;
      top: 0;
      height: 100%;
      width: 5px;
      background: transparent;
      cursor: col-resize;
      user-select: none;
      touch-action: none;
      z-index: 20;
    }

    .resizer:hover,
    .resizer.resizing {
      background: var(--secondary-color);
    }

    .resizer::after {
      content: '';
      position: absolute;
      right: 2px;
      top: 0;
      height: 100%;
      width: 1px;
      background: rgba(255, 255, 255, 0.3);
    }

    td:nth-child(3), td:nth-child(9), td:nth-child(10) {
      white-space: normal;
      word-wrap: break-word;
    }

    @media (max-width: 1200px) {
      .controls {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }
    }

    @media (max-width: 768px) {
      body {
        margin: 10px;
        padding: 10px;
      }
      
      .controls {
        grid-template-columns: 1fr;
      }
      
      .stats-bar {
        gap: 10px;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .tabs {
        flex-direction: column;
      }
      
      .tab {
        padding: 10px 16px;
        text-align: left;
      }
    }

    .error-message{
      color:#d9534f;padding:10px;margin:10px 0;
      border:1px solid #d9534f;border-radius:4px;background:#f9f2f2;
    }
    .success-message{
      color:#3c763d;padding:10px;margin:10px 0;
      border:1px solid #3c763d;border-radius:4px;background:#dff0d8;
    }
    
    .info-message{
      color:#0c5460;padding:10px;margin:10px 0;
      border:1px solid #bee5eb;border-radius:4px;background:#d1ecf1;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      display: none;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid var(--light-bg);
      border-top: 5px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Column Manager Modal */
    .column-manager-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .column-manager-modal.open {
      opacity: 1;
      visibility: visible;
    }

    .column-manager-content {
      background: var(--card-bg);
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-color);
    }

    .column-manager-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .column-manager-header h2 {
      margin: 0;
      color: var(--text-color);
      font-size: 20px;
    }

    .close-column-manager {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-light);
      cursor: pointer;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
    }

    .close-column-manager:hover {
      background: var(--light-bg);
      color: var(--text-color);
    }

    .column-manager-body {
      padding: 0 24px;
      overflow-y: auto;
      flex: 1;
    }

    .column-manager-search {
      padding: 16px 0;
      position: sticky;
      top: 0;
      background: var(--card-bg);
      z-index: 10;
    }

    .column-manager-search input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--light-bg);
      color: var(--text-color);
      font-size: 14px;
    }

    .column-manager-search input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(99, 171, 143, 0.2);
    }

    .column-manager-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .column-manager-actions button {
      padding: 8px 16px;
      border: 1px solid var(--border-color);
      background: var(--light-bg);
      color: var(--text-color);
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
    }

    .column-manager-actions button:hover {
      background: var(--pill);
    }

    .columns-list-container {
      padding-bottom: 20px;
    }

    .columns-category {
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
    }

    .category-header {
      padding: 12px 16px;
      background: var(--light-bg);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }

    .category-header:hover {
      background: var(--filter-bg);
    }

    .category-header h3 {
      margin: 0;
      font-size: 15px;
      color: var(--text-color);
      font-weight: 600;
    }

    .category-count {
      background: var(--pill);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 2px 10px;
      font-size: 12px;
      color: var(--text-light);
      font-weight: 500;
    }

    .category-content {
      padding: 12px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 10px;
      background: var(--card-bg);
    }

    .column-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 6px;
      background: var(--light-bg);
      transition: all 0.2s;
      cursor: pointer;
    }

    .column-item:hover {
      background: var(--pill);
      transform: translateY(-1px);
    }

    .column-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: var(--primary-color);
    }

    .column-label {
      flex: 1;
      font-size: 13px;
      color: var(--text-color);
      word-break: break-word;
    }

    .column-type {
      font-size: 11px;
      color: var(--text-light);
      background: var(--filter-bg);
      padding: 2px 6px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
    }

    .column-manager-footer {
      padding: 20px 24px;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .column-manager-footer button {
      padding: 10px 24px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .save-columns-btn {
      background: var(--primary-color);
      color: white;
      border: none;
    }

    .save-columns-btn:hover {
      background: var(--secondary-color);
    }

    .cancel-columns-btn {
      background: var(--light-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
    }

    .cancel-columns-btn:hover {
      background: var(--filter-bg);
    }

    .type-string {
      background: #e3f2fd;
      color: #1976d2;
    }

    .type-number {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .type-boolean {
      background: #fff3e0;
      color: #f57c00;
    }

    .type-date {
      background: #f3e5f5;
      color: #7b1fa2;
    }

    .type-object {
      background: #fce4ec;
      color: #c2185b;
    }

    .type-array {
      background: #e8eaf6;
      color: #3949ab;
    }

    .manage-columns-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: var(--light-bg);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      margin-left: 10px;
    }

    .manage-columns-btn:hover {
      background: var(--filter-bg);
    }
  </style>
</head>
<body>

  <div id="loginSection" class="card" style="text-align:center;margin:20px;">
    <div class="loading">Authenticating with PureCloud...</div>
  </div>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
  </div>

  <div id="appContent" style="display:none;">
    <div id="messageContainer" style="display:none;"></div>

    <h1 style="margin-bottom: 20px;">User Management Dashboard</h1>

    <div class="tabs">
      <button class="tab active" data-tab="active-users">Active Users</button>
      <button class="tab" data-tab="inactive-users">Inactive Users</button>
      <button class="tab" data-tab="roles-management">Roles Management</button>
    </div>

    <!-- Active Users Tab -->
    <div id="active-users" class="tab-content active">
      <div class="filter-section card">
        <h3>Filter Users</h3>
        
        <div class="controls">
          <div>
            <label>Select Management Units</label>
            <div id="managementUnitDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>Select Teams</label>
            <div id="teamDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>Filter by Status</label>
            <select id="statusFilter">
              <option value="">All Statuses</option>
              <option value="ON_QUEUE">On Queue</option>
              <option value="OFF_QUEUE">Off Queue</option>
              <option value="AVAILABLE">Available</option>
              <option value="OFFLINE">Offline</option>
              <option value="UNAVAILABLE">Unavailable</option>
              <option value="BUSY">Busy</option>
              <option value="MEETINGS">Meetings</option>
              <option value="BREAKS">Breaks</option>
              <option value="MEAL">Meal</option>
              <option value="AWAY">Away</option>
              <option value="TRAINING">Training</option>
              <option value="IDLE">Idle</option>
            </select>
          </div>
          <div>
            <label>Search Users</label>
            <input type="text" id="globalSearch" placeholder="Search name, email, skills..." />
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="fetchUsers" class="full-width-btn">Load Users</button>
          </div>
        </div>
        
        <div id="rateLimitInfo" class="rate-limit-info">
          Rate limit: <span id="rateLimitRemaining">100</span> remaining, resets in <span id="rateLimitReset">60</span>s
        </div>
      </div>

      <div class="card">
        <div id="progressContainer" class="progress-container" style="display:none;">
          <div class="progress-text">
            <span id="progressStatus">Loading users...</span>
            <span id="progressPercent">0%</span>
          </div>
          <div class="progress-bar">
            <div id="progressFill" class="progress-fill" style="width: 0%"></div>
          </div>
          <div class="progress-text">
            <span id="progressCount">0</span> of <span id="progressTotal">0</span> users loaded
          </div>
        </div>

        <div class="action-buttons">
          <button id="refreshData" class="action-btn">Refresh Data</button>
          <button id="exportCSV" class="action-btn export-btn">Export to CSV</button>
          <button id="clearFilters" class="action-btn" style="background: var(--danger);">Clear Filters</button>
          <button id="resetColumnWidths" class="action-btn" style="background: var(--warning); color: #000;">Reset Column Sizes</button>
          <button id="manageColumns" class="action-btn manage-columns-btn">
            <span>ðŸ“‹</span> Manage Columns
          </button>
          <select id="pageSize" style="margin-left: auto; width: auto;">
            <option value="25">25 per page</option>
            <option value="50" selected>50 per page</option>
            <option value="100">100 per page</option>
            <option value="200">200 per page</option>
          </select>
        </div>

        <div class="stats-bar" id="statsBar">
          <div class="stat-item">
            <span class="stat-value" id="totalUsers">0</span>
            <span class="stat-label">Total Users</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="onlineUsers">0</span>
            <span class="stat-label">Online</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="activeUsers">0</span>
            <span class="stat-label">Active Today</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="awayUsers">0</span>
            <span class="stat-label">Away</span>
          </div>
        </div>

        <div class="table-container">
          <table id="usersTable">
            <thead>
              <tr id="tableHeadersRow">
                <!-- Headers will be dynamically generated -->
              </tr>
              <tr class="filter-row" id="tableFiltersRow">
                <!-- Filters will be dynamically generated -->
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
          <div id="paginationInfo" class="muted"></div>
          <div>
            <button id="prevPage" class="action-btn" disabled>Previous</button>
            <button id="nextPage" class="action-btn" disabled>Next</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Inactive Users Tab -->
    <div id="inactive-users" class="tab-content">
      <div class="filter-section card">
        <h3>Find Inactive Users</h3>
        
        <div class="inactive-controls">
          <div>
            <label>Days Since Last Login (minimum)</label>
            <input type="number" id="daysSinceLogin" class="days-input" min="1" value="30" placeholder="30">
          </div>
          <div>
            <label>Date Range (optional)</label>
            <div class="date-range-inputs">
              <input type="date" id="dateFrom" placeholder="From date">
              <span>to</span>
              <input type="date" id="dateTo" placeholder="To date">
            </div>
          </div>
          <div>
            <label>Filter by Team</label>
            <select id="inactiveTeamFilter">
              <option value="">All Teams</option>
            </select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="findInactiveUsers" class="full-width-btn">Find Inactive Users</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="action-buttons">
          <button id="exportInactiveCSV" class="action-btn export-btn">Export Inactive Users to CSV</button>
          <button id="resetInactiveColumnWidths" class="action-btn" style="background: var(--warning); color: #000;">Reset Column Sizes</button>
        </div>

        <div class="stats-bar" id="inactiveStatsBar">
          <div class="stat-item">
            <span class="stat-value" id="totalInactiveUsers">0</span>
            <span class="stat-label">Inactive Users</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="avgDaysInactive">0</span>
            <span class="stat-label">Avg Days Inactive</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="maxDaysInactive">0</span>
            <span class="stat-label">Max Days Inactive</span>
          </div>
        </div>

        <div class="table-container">
          <table id="inactiveUsersTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Team</th>
                <th>Last Login</th>
                <th>Days Since Login</th>
                <th>Status</th>
                <th>Queues</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Roles Management Tab -->
    <div id="roles-management" class="tab-content">
      <div class="filter-section card">
        <h3>Roles Summary</h3>
        
        <div class="roles-controls">
          <div>
            <label>Search Roles</label>
            <input type="text" id="roleSearch" placeholder="Search role names..." />
          </div>
          <div>
            <label>Filter by Team</label>
            <select id="roleTeamFilter">
              <option value="">All Teams</option>
            </select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="refreshRoles" class="full-width-btn">Refresh Roles Data</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="action-buttons">
          <button id="exportRolesCSV" class="action-btn export-btn">Export Roles to CSV</button>
          <button id="showAllUsers" class="action-btn">View All Users by Role</button>
        </div>

        <div class="stats-bar" id="rolesStatsBar">
          <div class="stat-item">
            <span class="stat-value" id="totalRoles">0</span>
            <span class="stat-label">Total Roles</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="totalUsersWithRoles">0</span>
            <span class="stat-label">Users with Roles</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="avgUsersPerRole">0</span>
            <span class="stat-label">Avg Users per Role</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="maxUsersPerRole">0</span>
            <span class="stat-label">Max Users per Role</span>
          </div>
        </div>

        <div id="rolesContainer" style="margin-top: 20px;">
          <!-- Roles will be displayed here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Column Manager Modal -->
  <div id="columnManagerModal" class="column-manager-modal">
    <div class="column-manager-content">
      <div class="column-manager-header">
        <h2>Manage Table Columns</h2>
        <button class="close-column-manager" id="closeColumnManager">Ã—</button>
      </div>
      
      <div class="column-manager-body">
        <div class="column-manager-search">
          <input type="text" id="columnSearch" placeholder="Search columns..." />
        </div>
        
        <div class="column-manager-actions">
          <button id="selectAllColumns">Select All</button>
          <button id="deselectAllColumns">Deselect All</button>
          <button id="resetToDefault">Reset to Default</button>
          <div style="flex: 1"></div>
          <span id="selectedCount" style="font-size: 13px; color: var(--text-light);">
            <span id="selectedColumnsCount">0</span> columns selected
          </span>
        </div>
        
        <div id="columnsListContainer" class="columns-list-container">
          <!-- Columns will be populated here by JavaScript -->
        </div>
      </div>
      
      <div class="column-manager-footer">
        <button id="cancelColumns" class="cancel-columns-btn">Cancel</button>
        <button id="saveColumns" class="save-columns-btn">Save Changes</button>
      </div>
    </div>
  </div>

  <script>
    const clientId = 'fe305808-b368-4547-8af9-325d28d552bb';
    const redirectUri = 'https://gmcglynn88.github.io/Profiles/';
    const oauthUrl =
      `https://login.mypurecloud.ie/oauth/authorize?client_id=${clientId}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}`;

    let token = null;
    let availableUsers = [];
    let availableTeams = [];
    let availableManagementUnits = [];
    let userQueuesCache = new Map();
    let rolesData = {};
    
    let rateLimitRemaining = 100;
    let rateLimitResetTime = Date.now() + 60000;
    
    let currentPage = 1;
    let pageSize = 50;
    let sortColumn = 'name';
    let sortDirection = 'asc';
    let filters = {};
    let globalSearch = '';
    let filteredUsers = [];
    
    let inactiveUsers = [];
    
    // Column management variables
    let visibleColumns = [];
    let allColumns = [];
    let columnCategories = {};
    
    // Default columns to show
    const DEFAULT_VISIBLE_COLUMNS = [
      'id',
      'name',
      'email',
      'authorization.roles.name',
      'routingStatus.status',
      'presence.presenceDefinition.systemPresence',
      'team.name',
      'dateLastLogin',
      'daysSinceLastLogin',
      'skills.name',
      'queues'
    ];

    // Column resizing variables
    let activeResizer = null;
    let startX = 0;
    let startWidth = 0;
    let columnIndex = 0;
    let tableElement = null;
    let originalWidths = {};
    
    const MAX_PAGE_SIZE = 100;
    const REQUEST_DELAY = 200;
    let isFetching = false;

    // Status color mapping function
    function getStatusClass(presence) {
      if (!presence) return 'status-offline';
      
      const status = String(presence).toLowerCase().trim();
      
      if (status.includes('on queue') || status === 'on_queue') return 'status-onqueue';
      if (status.includes('off queue') || status === 'off_queue') return 'status-offqueue';
      if (status.includes('available')) return 'status-available';
      if (status.includes('offline')) return 'status-offline';
      if (status.includes('unavailable')) return 'status-unavailable';
      if (status.includes('busy')) return 'status-busy';
      if (status.includes('meeting')) return 'status-meetings';
      if (status.includes('break')) return 'status-breaks';
      if (status.includes('meal')) return 'status-meal';
      if (status.includes('away')) return 'status-away';
      if (status.includes('train')) return 'status-training';
      if (status.includes('idle')) return 'status-idle';
      
      return 'status-offline';
    }

    document.addEventListener('DOMContentLoaded', () => {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      token = params.get("access_token");

      if (!token) {
        window.location.href = oauthUrl;
        return;
      }

      document.getElementById("loginSection").style.display = "none";
      document.getElementById("appContent").style.display = "block";

      initializeApp();
    });

    function showMessage(message, type = 'error') {
      const msgBox = document.getElementById('messageContainer');
      msgBox.innerHTML = `<div class="${type}-message">${message}</div>`;
      msgBox.style.display = 'block';
      if (type === 'success') setTimeout(() => (msgBox.style.display = 'none'), 5000);
    }

    function authHeaders() {
      return { 
        Authorization: `Bearer ${token}`, 
        "Content-Type": "application/json" 
      };
    }

    function updateRateLimitInfo(headers) {
      if (headers) {
        const remaining = headers.get('RateLimit-Remaining');
        const reset = headers.get('RateLimit-Reset');
        
        if (remaining !== null) {
          rateLimitRemaining = parseInt(remaining);
          document.getElementById('rateLimitRemaining').textContent = remaining;
        }
        
        if (reset !== null) {
          const resetSeconds = parseInt(reset);
          rateLimitResetTime = Date.now() + (resetSeconds * 1000);
          document.getElementById('rateLimitReset').textContent = resetSeconds;
          
          if (rateLimitRemaining < 20) {
            document.getElementById('rateLimitInfo').style.display = 'block';
            document.getElementById('rateLimitInfo').style.background = 'var(--warning)';
          } else if (rateLimitRemaining < 50) {
            document.getElementById('rateLimitInfo').style.display = 'block';
          } else {
            document.getElementById('rateLimitInfo').style.display = 'none';
          }
        }
      }
    }

    async function rateLimitedFetch(url, options = {}) {
      if (rateLimitRemaining < 5) {
        const waitTime = rateLimitResetTime - Date.now();
        if (waitTime > 0) {
          showMessage(`Rate limit reached. Waiting ${Math.ceil(waitTime / 1000)} seconds...`, 'info');
          await new Promise(resolve => setTimeout(resolve, waitTime));
        }
      }
      
      if (isFetching) {
        await new Promise(resolve => setTimeout(resolve, REQUEST_DELAY));
      }
      
      const response = await fetch(url, {
        ...options,
        headers: { ...authHeaders(), ...options.headers }
      });
      
      updateRateLimitInfo(response.headers);
      
      if (!response.ok) {
        if (response.status === 429) {
          const retryAfter = response.headers.get('Retry-After') || 60;
          showMessage(`Rate limited. Retrying in ${retryAfter} seconds...`, 'info');
          await new Promise(resolve => setTimeout(resolve, retryAfter * 1000));
          return rateLimitedFetch(url, options);
        }
        throw new Error(`API error: ${response.status} ${response.statusText}`);
      }
      
      return response;
    }

    function initializeColumnManager() {
      allColumns = [
        // Basic Info Category
        { id: 'id', label: 'User ID', category: 'Basic Info', type: 'string', default: true },
        { id: 'name', label: 'Name', category: 'Basic Info', type: 'string', default: true },
        { id: 'division.id', label: 'Division ID', category: 'Basic Info', type: 'string', default: false },
        { id: 'division.name', label: 'Division Name', category: 'Basic Info', type: 'string', default: false },
        { id: 'chat', label: 'Chat', category: 'Basic Info', type: 'string', default: false },
        { id: 'email', label: 'Email', category: 'Basic Info', type: 'string', default: true },
        { id: 'username', label: 'Username', category: 'Basic Info', type: 'string', default: false },
        { id: 'version', label: 'Version', category: 'Basic Info', type: 'number', default: false },
        { id: 'state', label: 'State', category: 'Basic Info', type: 'string', default: false },
        { id: 'manager', label: 'Manager', category: 'Basic Info', type: 'string', default: false },
        
        // Contact Information Category
        { id: 'primaryContactInfo.address', label: 'Primary Contact Address', category: 'Contact Information', type: 'string', default: false },
        { id: 'primaryContactInfo.mediaType', label: 'Primary Contact Media Type', category: 'Contact Information', type: 'string', default: false },
        { id: 'primaryContactInfo.type', label: 'Primary Contact Type', category: 'Contact Information', type: 'string', default: false },
        { id: 'addresses.address', label: 'Address', category: 'Contact Information', type: 'string', default: false },
        { id: 'addresses.display', label: 'Address Display', category: 'Contact Information', type: 'string', default: false },
        { id: 'addresses.mediaType', label: 'Address Media Type', category: 'Contact Information', type: 'string', default: false },
        { id: 'addresses.type', label: 'Address Type', category: 'Contact Information', type: 'string', default: false },
        { id: 'addresses.extension', label: 'Address Extension', category: 'Contact Information', type: 'string', default: false },
        { id: 'addresses.countryCode', label: 'Country Code', category: 'Contact Information', type: 'string', default: false },
        
        // Employment Info Category
        { id: 'employerInfo.officialName', label: 'Official Name', category: 'Employment Info', type: 'string', default: false },
        { id: 'employerInfo.employeeId', label: 'Employee ID', category: 'Employment Info', type: 'string', default: false },
        { id: 'employerInfo.employeeType', label: 'Employee Type', category: 'Employment Info', type: 'string', default: false },
        { id: 'employerInfo.dateHire', label: 'Hire Date', category: 'Employment Info', type: 'date', default: false },
        
        // Status & Presence Category
        { id: 'routingStatus.status', label: 'Routing Status', category: 'Status & Presence', type: 'string', default: true },
        { id: 'routingStatus.startTime', label: 'Routing Start Time', category: 'Status & Presence', type: 'date', default: false },
        { id: 'presence.source', label: 'Presence Source', category: 'Status & Presence', type: 'string', default: false },
        { id: 'presence.presenceDefinition.id', label: 'Presence Definition ID', category: 'Status & Presence', type: 'string', default: false },
        { id: 'presence.presenceDefinition.systemPresence', label: 'System Presence', category: 'Status & Presence', type: 'string', default: true },
        { id: 'presence.presenceDefinition.selfUri', label: 'Presence Definition URI', category: 'Status & Presence', type: 'string', default: false },
        { id: 'presence.message', label: 'Presence Message', category: 'Status & Presence', type: 'string', default: false },
        { id: 'presence.modifiedDate', label: 'Presence Modified Date', category: 'Status & Presence', type: 'date', default: false },
        { id: 'outOfOffice.active', label: 'Out of Office Active', category: 'Status & Presence', type: 'boolean', default: false },
        { id: 'outOfOffice.indefinite', label: 'Out of Office Indefinite', category: 'Status & Presence', type: 'boolean', default: false },
        { id: 'acdAutoAnswer', label: 'ACD Auto Answer', category: 'Status & Presence', type: 'boolean', default: false },
        
        // Authorization & Roles Category
        { id: 'authorization.roles.id', label: 'Role IDs', category: 'Authorization & Roles', type: 'array', default: false },
        { id: 'authorization.roles.name', label: 'Roles', category: 'Authorization & Roles', type: 'array', default: true },
        { id: 'authorization.unusedRoles.id', label: 'Unused Role IDs', category: 'Authorization & Roles', type: 'array', default: false },
        { id: 'authorization.unusedRoles.name', label: 'Unused Roles', category: 'Authorization & Roles', type: 'array', default: false },
        { id: 'authorization.permissions', label: 'Permissions', category: 'Authorization & Roles', type: 'array', default: false },
        { id: 'authorization.permissionPolicies.domain', label: 'Permission Domain', category: 'Authorization & Roles', type: 'string', default: false },
        { id: 'authorization.permissionPolicies.entityName', label: 'Permission Entity Name', category: 'Authorization & Roles', type: 'string', default: false },
        { id: 'authorization.permissionPolicies.allowConditions', label: 'Allow Conditions', category: 'Authorization & Roles', type: 'boolean', default: false },
        { id: 'authorization.permissionPolicies.actionSet', label: 'Action Set', category: 'Authorization & Roles', type: 'array', default: false },
        
        // Skills & Certifications Category
        { id: 'certifications', label: 'Certifications', category: 'Skills & Certifications', type: 'array', default: false },
        { id: 'profileSkills', label: 'Profile Skills', category: 'Skills & Certifications', type: 'array', default: false },
        { id: 'skills.id', label: 'Skill IDs', category: 'Skills & Certifications', type: 'array', default: false },
        { id: 'skills.name', label: 'Skills', category: 'Skills & Certifications', type: 'array', default: true },
        { id: 'skills.proficiency', label: 'Skill Proficiency', category: 'Skills & Certifications', type: 'number', default: false },
        { id: 'skills.state', label: 'Skill State', category: 'Skills & Certifications', type: 'string', default: false },
        { id: 'languages', label: 'Languages', category: 'Skills & Certifications', type: 'array', default: false },
        
        // Organization & Groups Category
        { id: 'locations', label: 'Locations', category: 'Organization & Groups', type: 'array', default: false },
        { id: 'groups.id', label: 'Group IDs', category: 'Organization & Groups', type: 'array', default: false },
        { id: 'team.id', label: 'Team ID', category: 'Organization & Groups', type: 'string', default: false },
        { id: 'team.name', label: 'Team', category: 'Organization & Groups', type: 'string', default: true },
        { id: 'team.selfUri', label: 'Team URI', category: 'Organization & Groups', type: 'string', default: false },
        
        // Work & Scheduling Category
        { id: 'workPlanBidRanks.id', label: 'Work Plan Bid Ranks', category: 'Work & Scheduling', type: 'array', default: false },
        
        // External Contacts Category
        { id: 'externalContactsSettings.manuallyAssignDivisionsToInteractions', label: 'Manual Division Assignment to Interactions', category: 'External Contacts', type: 'boolean', default: false },
        { id: 'externalContactsSettings.manuallyAssignDivisionsToContacts', label: 'Manual Division Assignment to Contacts', category: 'External Contacts', type: 'boolean', default: false },
        
        // Token & Login Category
        { id: 'lastTokenIssued.dateIssued', label: 'Last Token Issued Date', category: 'Token & Login', type: 'date', default: false },
        { id: 'dateLastLogin', label: 'Last Login Date', category: 'Token & Login', type: 'date', default: true },
        { id: 'dateWelcomeSent', label: 'Welcome Sent Date', category: 'Token & Login', type: 'date', default: false },
        
        // Calculated Fields (not from API directly)
        { id: 'daysSinceLastLogin', label: 'Days Since Login', category: 'Calculated Fields', type: 'number', default: true },
        { id: 'queues', label: 'Queues', category: 'Calculated Fields', type: 'array', default: true }
      ];
      
      // Load saved column preferences from localStorage
      const savedColumns = localStorage.getItem('visibleColumns');
      if (savedColumns) {
        visibleColumns = JSON.parse(savedColumns);
      } else {
        visibleColumns = [...DEFAULT_VISIBLE_COLUMNS];
      }
      
      // Group columns by category
      columnCategories = {};
      allColumns.forEach(column => {
        if (!columnCategories[column.category]) {
          columnCategories[column.category] = [];
        }
        columnCategories[column.category].push(column);
      });
    }

    async function initializeApp() {
      try {
        showLoading(true);
        
        // Initialize column manager first
        initializeColumnManager();
        
        await Promise.all([
          fetchAllTeams(),
          fetchAllManagementUnits()
        ]);

        createDropdowns();
        populateDropdownOptions();
        setupEventListeners();
        setupTabs();
        
        // Render table headers with saved preferences
        renderTableHeaders();
        
        showLoading(false);

      } catch (e) {
        console.error(e);
        showMessage("Error initialising. Redirecting...");
        setTimeout(() => window.location.href = oauthUrl, 2000);
      }
    }

    async function fetchAllTeams() {
      let all = [], page = 1;
      const size = 100;
      
      try {
        do {
          const res = await rateLimitedFetch(
            `https://api.mypurecloud.ie/api/v2/teams?pageNumber=${page}&pageSize=${size}`
          );
          const data = await res.json();
          all = all.concat(data.entities || []);
          page++;
          
          if (!data.entities || data.entities.length < size) break;
          
        } while (true);
        
        availableTeams = all;
        
        const inactiveTeamFilter = document.getElementById('inactiveTeamFilter');
        const roleTeamFilter = document.getElementById('roleTeamFilter');
        
        availableTeams.forEach(team => {
          const option1 = document.createElement('option');
          option1.value = team.id;
          option1.textContent = team.name;
          inactiveTeamFilter.appendChild(option1);
          
          const option2 = document.createElement('option');
          option2.value = team.id;
          option2.textContent = team.name;
          roleTeamFilter.appendChild(option2);
        });
        
      } catch (error) {
        console.error('Error fetching teams:', error);
        showMessage('Error loading teams');
      }
    }

    async function fetchAllManagementUnits() {
      let all = [], page = 1;
      const size = 100;
      
      try {
        do {
          const res = await rateLimitedFetch(
            `https://api.mypurecloud.ie/api/v2/workforcemanagement/managementunits?pageNumber=${page}&pageSize=${size}`
          );
          const data = await res.json();
          all = all.concat(data.entities || []);
          page++;
          
          if (!data.entities || data.entities.length < size) break;
          
        } while (true);
        
        availableManagementUnits = all;
      } catch (error) {
        console.error('Error fetching management units:', error);
        showMessage('Error loading management units');
      }
    }

    async function fetchUserQueues(userId) {
      if (userQueuesCache.has(userId)) {
        return userQueuesCache.get(userId);
      }
      
      try {
        const response = await rateLimitedFetch(
          `https://api.mypurecloud.ie/api/v2/users/${userId}/queues?pageSize=50`
        );
        const data = await response.json();
        const queues = data.entities || [];
        const queueNames = queues.map(q => q.name).slice(0, 10);
        userQueuesCache.set(userId, queueNames);
        return queueNames;
      } catch (error) {
        console.error(`Error fetching queues for user ${userId}:`, error);
        return [];
      }
    }

    async function fetchUsers() {
      if (isFetching) {
        showMessage('Already fetching data, please wait...', 'info');
        return;
      }
      
      try {
        isFetching = true;
        document.getElementById('fetchUsers').disabled = true;
        document.getElementById('fetchUsers').textContent = 'Loading...';
        
        const progressContainer = document.getElementById('progressContainer');
        progressContainer.style.display = 'block';
        
        const expandFields = [
          'routingStatus',
          'presence',
          'integrationPresence',
          'conversationSummary',
          'outOfOffice',
          'geolocation',
          'station',
          'authorization',
          'lasttokenissued',
          'authorization.unusedRoles',
          'team',
          'workPlanBidRanks',
          'externalContactsSettings',
          'groups',
          'customAttributes',
          'profileSkills',
          'certifications',
          'skills',
          'languages',
          'languagePreference',
          'employerInfo',
          'biography',
          'dateLastLogin',
          'dateWelcomeSent'
        ].join(',');

        let allUsers = [];
        let page = 1;
        let totalUsers = 0;
        let loadedCount = 0;
        
        try {
          const countRes = await rateLimitedFetch(
            `https://api.mypurecloud.ie/api/v2/users?pageSize=1&pageNumber=1`
          );
          const countData = await countRes.json();
          totalUsers = countData.total || 0;
          document.getElementById('progressTotal').textContent = totalUsers;
        } catch (error) {
          console.warn('Could not get total count:', error);
          totalUsers = 1000;
        }

        while (true) {
          try {
            document.getElementById('progressStatus').textContent = `Loading page ${page}...`;
            
            const res = await rateLimitedFetch(
              `https://api.mypurecloud.ie/api/v2/users?expand=${expandFields}&pageNumber=${page}&pageSize=${MAX_PAGE_SIZE}`
            );
            
            const data = await res.json();
            const users = data.entities || [];
            
            const validUsers = users.filter(u => 
              u.name && u.name.trim() && u.name !== 'Unknown User'
            );
            
            validUsers.forEach(user => {
              if (user.dateLastLogin) {
                const lastLogin = new Date(user.dateLastLogin);
                const today = new Date();
                const diffTime = Math.abs(today - lastLogin);
                user.daysSinceLastLogin = Math.floor(diffTime / (1000 * 60 * 60 * 24));
              } else {
                user.daysSinceLastLogin = 999;
              }
              
              if (user.authorization && user.authorization.roles) {
                user.roles = user.authorization.roles.map(r => r.name);
              } else {
                user.roles = [];
              }
            });
            
            allUsers = allUsers.concat(validUsers);
            loadedCount += users.length;
            
            const progressPercent = Math.min(Math.round((loadedCount / totalUsers) * 100), 100);
            document.getElementById('progressFill').style.width = `${progressPercent}%`;
            document.getElementById('progressPercent').textContent = `${progressPercent}%`;
            document.getElementById('progressCount').textContent = loadedCount;
            
            if (!data.pageCount || page >= data.pageCount || users.length < MAX_PAGE_SIZE) {
              break;
            }
            
            page++;
            
            await new Promise(resolve => setTimeout(resolve, REQUEST_DELAY));
            
          } catch (error) {
            console.error(`Error fetching page ${page}:`, error);
            
            if (error.message.includes('429')) {
              await new Promise(resolve => setTimeout(resolve, 5000));
              continue;
            }
            
            showMessage(`Stopped loading at page ${page}. ${error.message}`, 'warning');
            break;
          }
        }
        
        availableUsers = allUsers;
        
        progressContainer.style.display = 'none';
        
        setupColumnResizing();
        
        applyFilters();
        renderTable();
        
        updateRolesData();
        
        showMessage(`Successfully loaded ${availableUsers.length} users`, 'success');
        
      } catch (error) {
        console.error('Error fetching users:', error);
        showMessage(`Error loading users: ${error.message}`);
        
        document.getElementById('progressContainer').style.display = 'none';
      } finally {
        isFetching = false;
        document.getElementById('fetchUsers').disabled = false;
        document.getElementById('fetchUsers').textContent = 'Load Users';
      }
    }

    function updateRolesData() {
      rolesData = {};
      
      availableUsers.forEach(user => {
        if (user.roles && user.roles.length > 0) {
          user.roles.forEach(role => {
            if (!rolesData[role]) {
              rolesData[role] = {
                users: [],
                teams: new Set()
              };
            }
            rolesData[role].users.push(user);
            if (user.team && user.team.name) {
              rolesData[role].teams.add(user.team.name);
            }
          });
        }
      });
      
      const sortedRoles = Object.keys(rolesData).sort((a, b) => 
        rolesData[b].users.length - rolesData[a].users.length
      );
      
      document.getElementById('totalRoles').textContent = sortedRoles.length;
      document.getElementById('totalUsersWithRoles').textContent = availableUsers.filter(u => u.roles && u.roles.length > 0).length;
      
      const usersPerRole = sortedRoles.map(role => rolesData[role].users.length);
      if (usersPerRole.length > 0) {
        const avg = Math.round(usersPerRole.reduce((a, b) => a + b, 0) / usersPerRole.length);
        const max = Math.max(...usersPerRole);
        document.getElementById('avgUsersPerRole').textContent = avg;
        document.getElementById('maxUsersPerRole').textContent = max;
      }
      
      renderRoles();
    }

    function renderRoles() {
      const container = document.getElementById('rolesContainer');
      const roleSearch = document.getElementById('roleSearch').value.toLowerCase();
      const teamFilter = document.getElementById('roleTeamFilter').value;
      
      const sortedRoles = Object.keys(rolesData).sort((a, b) => 
        rolesData[b].users.length - rolesData[a].users.length
      );
      
      const filteredRoles = sortedRoles.filter(role => {
        if (roleSearch && !role.toLowerCase().includes(roleSearch)) {
          return false;
        }
        
        if (teamFilter) {
          const hasTeam = rolesData[role].users.some(user => 
            user.team && user.team.id === teamFilter
          );
          if (!hasTeam) return false;
        }
        
        return true;
      });
      
      if (filteredRoles.length === 0) {
        container.innerHTML = `<div style="text-align:center;padding:40px;color:var(--text-light)}">
          No roles found. Try adjusting your filters or load users first.
        </div>`;
        return;
      }
      
      container.innerHTML = filteredRoles.map(role => {
        const roleInfo = rolesData[role];
        const userCount = roleInfo.users.length;
        const teamCount = roleInfo.teams.size;
        const sampleUsers = roleInfo.users.slice(0, 5);
        const teams = Array.from(roleInfo.teams).slice(0, 3);
        
        return `
          <div class="role-card">
            <div class="role-header">
              <div class="role-name">${role}</div>
              <div class="role-count">${userCount} user${userCount !== 1 ? 's' : ''}</div>
            </div>
            <div style="font-size:13px;color:var(--text-light);margin-bottom:8px;">
              ${teamCount} team${teamCount !== 1 ? 's' : ''}: ${teams.join(', ')}${teamCount > 3 ? '...' : ''}
            </div>
            <div class="role-users">
              ${sampleUsers.map(user => `<span>${user.name}</span>`).join('')}
              ${userCount > 5 ? `<span>+${userCount - 5} more</span>` : ''}
            </div>
            <div class="role-actions">
              <button onclick="viewRoleUsers('${role.replace(/'/g, "\\'")}')" class="action-btn">View Users</button>
              <button onclick="exportRoleUsers('${role.replace(/'/g, "\\'")}')" class="action-btn export-btn">Export Users</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function viewRoleUsers(roleName) {
      if (!rolesData[roleName]) return;
      
      const roleInfo = rolesData[roleName];
      const users = roleInfo.users;
      
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      document.querySelector('.tab[data-tab="active-users"]').classList.add('active');
      document.getElementById('active-users').classList.add('active');
      
      clearFilters();
      
      const rolesFilter = document.querySelector('.column-filter[data-column="authorization.roles.name"]');
      if (rolesFilter) {
        rolesFilter.value = roleName;
        filters['authorization.roles.name'] = roleName;
      }
      
      applyFilters();
      renderTable();
      
      showMessage(`Showing ${users.length} users with role: ${roleName}`, 'success');
    }

    function exportRoleUsers(roleName) {
      if (!rolesData[roleName]) {
        showMessage('Role not found', 'error');
        return;
      }
      
      const roleInfo = rolesData[roleName];
      const users = roleInfo.users;
      
      if (users.length === 0) {
        showMessage('No users with this role', 'info');
        return;
      }
      
      const headers = [
        'Name', 'Email', 'Role', 'Status', 'Team', 'Presence',
        'Last Login', 'Days Since Login', 'Skills', 'User ID'
      ];
      
      const data = users.map(user => [
        user.name || '',
        user.email || '',
        roleName,
        user.routingStatus?.status || '',
        user.team?.name || '',
        user.presence?.presenceDefinition?.systemPresence || '',
        user.dateLastLogin ? new Date(user.dateLastLogin).toISOString() : '',
        user.daysSinceLastLogin || 0,
        user.skills?.map(s => s.name).join('; ') || '',
        user.id || ''
      ]);
      
      const csvContent = [
        headers.join(','),
        ...data.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
      ].join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `role_${roleName.replace(/[^a-z0-9]/gi, '_')}_users_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      showMessage(`Exported ${users.length} users with role "${roleName}" to CSV`, 'success');
    }

    function applyFilters() {
      filteredUsers = [...availableUsers];
      
      if (globalSearch) {
        const search = globalSearch.toLowerCase();
        filteredUsers = filteredUsers.filter(user => {
          return (
            (user.name && user.name.toLowerCase().includes(search)) ||
            (user.email && user.email.toLowerCase().includes(search)) ||
            (user.roles && user.roles.some(role => role.toLowerCase().includes(search))) ||
            (user.skills && user.skills.some(skill => 
              skill.name && skill.name.toLowerCase().includes(search)
            )) ||
            (user.team && user.team.name && user.team.name.toLowerCase().includes(search))
          );
        });
      }
      
      Object.keys(filters).forEach(column => {
        const filterValue = filters[column].toLowerCase().trim();
        if (!filterValue) return;
        
        filteredUsers = filteredUsers.filter(user => {
          const value = getNestedValue(user, column);
          
          if (value === undefined || value === null) return false;
          
          if (Array.isArray(value)) {
            return value.some(item => 
              String(item).toLowerCase().includes(filterValue)
            );
          }
          
          if (column.includes('date') || column.includes('Date')) {
            const dateStr = new Date(value).toISOString().split('T')[0];
            return dateStr.includes(filterValue);
          }
          
          if (column.includes('daysSinceLastLogin')) {
            const days = parseInt(value) || 0;
            const filterDays = parseInt(filterValue) || 0;
            return days >= filterDays;
          }
          
          return String(value).toLowerCase().includes(filterValue);
        });
      });
      
      const statusFilter = document.getElementById('statusFilter').value;
      if (statusFilter) {
        filteredUsers = filteredUsers.filter(user => {
          if (!user.presence || !user.presence.presenceDefinition) return false;
          return user.presence.presenceDefinition.systemPresence === statusFilter;
        });
      }
      
      const selectedTeams = teamDropdown.getSelectedValues();
      if (selectedTeams.length > 0) {
        filteredUsers = filteredUsers.filter(user => 
          user.team && selectedTeams.includes(user.team.id)
        );
      }
      
      const selectedMUs = managementUnitDropdown.getSelectedValues();
      if (selectedMUs.length > 0) {
        filteredUsers = filteredUsers.filter(user => {
          return user.team && selectedTeams.length > 0;
        });
      }
      
      updateStats();
    }

    function getNestedValue(obj, path) {
      return path.split('.').reduce((current, key) => {
        return current ? current[key] : undefined;
      }, obj);
    }

    function sortUsers(users) {
      return users.sort((a, b) => {
        let valA = getNestedValue(a, sortColumn);
        let valB = getNestedValue(b, sortColumn);
        
        if (Array.isArray(valA)) {
          valA = valA.map(v => v.name || v).join(', ');
        }
        if (Array.isArray(valB)) {
          valB = valB.map(v => v.name || v).join(', ');
        }
        
        if (sortColumn.includes('date') || sortColumn.includes('Date') || sortColumn === 'dateLastLogin') {
          valA = valA ? new Date(valA).getTime() : 0;
          valB = valB ? new Date(valB).getTime() : 0;
        }
        
        if (sortColumn === 'daysSinceLastLogin') {
          valA = Number(valA) || 0;
          valB = Number(valB) || 0;
        }
        
        valA = String(valA || '').toLowerCase();
        valB = String(valB || '').toLowerCase();
        
        if (sortDirection === 'asc') {
          return valA.localeCompare(valB, undefined, { numeric: true });
        } else {
          return valB.localeCompare(valA, undefined, { numeric: true });
        }
      });
    }

    function renderTableHeaders() {
      const thead = document.querySelector('#usersTable thead');
      const headerRow = document.getElementById('tableHeadersRow');
      const filterRow = document.getElementById('tableFiltersRow');
      
      if (!headerRow || !filterRow) return;
      
      headerRow.innerHTML = '';
      filterRow.innerHTML = '';
      
      visibleColumns.forEach(columnId => {
        const column = allColumns.find(c => c.id === columnId);
        if (!column) return;
        
        const th = document.createElement('th');
        th.className = 'sortable';
        th.dataset.column = columnId;
        th.textContent = column.label;
        
        const resizer = document.createElement('div');
        resizer.className = 'resizer';
        resizer.dataset.index = visibleColumns.indexOf(columnId);
        th.appendChild(resizer);
        th.style.position = 'relative';
        
        th.addEventListener('click', function() {
          const column = this.dataset.column;
          
          if (sortColumn === column) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
          } else {
            sortColumn = column;
            sortDirection = 'asc';
          }
          
          renderTable();
        });
        
        headerRow.appendChild(th);
        
        const filterTd = document.createElement('td');
        
        if (column.type === 'string' || column.type === 'array') {
          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'column-filter';
          input.dataset.column = columnId;
          input.placeholder = `Filter ${column.label.toLowerCase()}...`;
          input.addEventListener('input', function() {
            const column = this.dataset.column;
            if (this.value.trim()) {
              filters[column] = this.value;
            } else {
              delete filters[column];
            }
            currentPage = 1;
            applyFilters();
            renderTable();
          });
          filterTd.appendChild(input);
        } else if (column.type === 'date') {
          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'column-filter';
          input.dataset.column = columnId;
          input.placeholder = 'YYYY-MM-DD...';
          input.addEventListener('input', function() {
            const column = this.dataset.column;
            if (this.value.trim()) {
              filters[column] = this.value;
            } else {
              delete filters[column];
            }
            currentPage = 1;
            applyFilters();
            renderTable();
          });
          filterTd.appendChild(input);
        } else if (column.id === 'routingStatus.status') {
          const select = document.createElement('select');
          select.className = 'column-filter';
          select.dataset.column = columnId;
          select.innerHTML = `
            <option value="">All</option>
            <option value="ON_QUEUE">On Queue</option>
            <option value="OFF_QUEUE">Off Queue</option>
            <option value="AVAILABLE">Available</option>
            <option value="OFFLINE">Offline</option>
            <option value="UNAVAILABLE">Unavailable</option>
            <option value="BUSY">Busy</option>
            <option value="MEETINGS">Meetings</option>
            <option value="BREAKS">Breaks</option>
            <option value="MEAL">Meal</option>
            <option value="AWAY">Away</option>
            <option value="TRAINING">Training</option>
            <option value="IDLE">Idle</option>
          `;
          select.addEventListener('change', function() {
            const column = this.dataset.column;
            if (this.value) {
              filters[column] = this.value;
            } else {
              delete filters[column];
            }
            currentPage = 1;
            applyFilters();
            renderTable();
          });
          filterTd.appendChild(select);
        } else {
          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'column-filter';
          input.dataset.column = columnId;
          input.placeholder = 'Filter...';
          filterTd.appendChild(input);
        }
        
        filterRow.appendChild(filterTd);
      });
      
      updateSortIndicators();
    }

    async function renderTable() {
      const tbody = document.querySelector('#usersTable tbody');
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageUsers = sortUsers([...filteredUsers]).slice(start, end);
      
      if (pageUsers.length === 0) {
        tbody.innerHTML = `<tr><td colspan="${visibleColumns.length}" style="text-align:center;padding:40px;color:var(--text-light)}">
          No users found. Try adjusting your filters or click "Load Users".
        </td></tr>`;
        updatePaginationInfo(0, 0);
        return;
      }
      
      const queuePromises = pageUsers.map(user => fetchUserQueues(user.id));
      const queuesList = await Promise.all(queuePromises);
      
      tbody.innerHTML = pageUsers.map((user, index) => {
        const rowCells = visibleColumns.map(columnId => {
          let cellValue = getNestedValue(user, columnId);
          
          if (columnId === 'skills.name') {
            const skills = user.skills?.map(s => s.name) || [];
            return `
              <td>
                <div class="skills-list" title="${skills.join(', ') || 'None'}">
                  ${skills.slice(0, 5).map(skill => `<span>${skill}</span>`).join('')}
                  ${skills.length > 5 ? '<span>...</span>' : ''}
                  ${skills.length === 0 ? '<span style="color: var(--text-light);">None</span>' : ''}
                </div>
              </td>
            `;
          }
          
          if (columnId === 'queues') {
            const userQueues = queuesList[index] || [];
            return `
              <td>
                <div class="queues-list" title="${userQueues.join(', ')}">
                  ${userQueues.slice(0, 5).map(queue => `<span>${queue}</span>`).join('')}
                  ${userQueues.length > 5 ? '<span>...</span>' : ''}
                  ${userQueues.length === 0 ? '<span style="color: var(--text-light);">None</span>' : ''}
                </div>
              </td>
            `;
          }
          
          if (columnId === 'authorization.roles.name') {
            const roles = user.roles || [];
            return `
              <td>
                <div class="roles-list" title="${roles.join(', ') || 'No role'}">
                  ${roles.slice(0, 5).map(role => `<span>${role}</span>`).join('')}
                  ${roles.length > 5 ? '<span>...</span>' : ''}
                  ${roles.length === 0 ? '<span style="color: var(--text-light);">No role</span>' : ''}
                </div>
              </td>
            `;
          }
          
          if (columnId === 'routingStatus.status') {
            const status = cellValue || 'UNKNOWN';
            const presence = user.presence?.presenceDefinition?.systemPresence || 'Offline';
            const statusClass = getStatusClass(presence);
            return `
              <td>
                <span class="status-badge ${statusClass}">${presence}</span><br>
                <small class="muted">${status}</small>
              </td>
            `;
          }
          
          if (columnId === 'presence.presenceDefinition.systemPresence') {
            const presence = cellValue || 'Offline';
            const statusClass = getStatusClass(presence);
            return `<td><span class="status-badge ${statusClass}">${presence}</span></td>`;
          }
          
          if (columnId === 'team.name') {
            return `<td>${cellValue || 'Unassigned'}</td>`;
          }
          
          if (columnId === 'dateLastLogin') {
            if (!cellValue) return `<td>Never</td>`;
            const date = new Date(cellValue);
            return `<td>${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>`;
          }
          
          if (columnId === 'daysSinceLastLogin') {
            const days = cellValue || 0;
            let daysClass = '';
            if (days > 30) daysClass = 'style="color: var(--danger); font-weight: bold;"';
            else if (days > 7) daysClass = 'style="color: var(--warning);"';
            return `<td style="text-align:center;" ${daysClass}>${days === 999 ? 'Never' : days}</td>`;
          }
          
          if (columnId === 'email') {
            return `<td>${cellValue || 'No email'}</td>`;
          }
          
          if (columnId === 'name') {
            return `<td><strong>${cellValue || 'Unknown'}</strong></td>`;
          }
          
          if (columnId === 'id') {
            return `<td><small style="color: var(--text-light);">${cellValue || ''}</small></td>`;
          }
          
          if (Array.isArray(cellValue)) {
            return `<td>${cellValue.join(', ') || ''}</td>`;
          }
          
          if (typeof cellValue === 'object' && cellValue !== null) {
            return `<td>${JSON.stringify(cellValue)}</td>`;
          }
          
          return `<td>${cellValue || ''}</td>`;
        }).join('');
        
        return `<tr>${rowCells}</tr>`;
      }).join('');
      
      updatePaginationInfo(start, end);
      updateSortIndicators();
    }

    function updatePaginationInfo(start, end) {
      const total = filteredUsers.length;
      document.getElementById('paginationInfo').textContent = 
        `Showing ${start + 1}-${Math.min(end, total)} of ${total} users`;
      
      document.getElementById('prevPage').disabled = currentPage === 1;
      document.getElementById('nextPage').disabled = end >= total;
    }

    function updateSortIndicators() {
      document.querySelectorAll('.sortable').forEach(th => {
        th.classList.remove('asc', 'desc');
        if (th.dataset.column === sortColumn) {
          th.classList.add(sortDirection);
        }
      });
    }

    function updateStats() {
      const total = filteredUsers.length;
      const online = filteredUsers.filter(u => 
        u.presence?.presenceDefinition?.systemPresence === 'Available' || 
        u.presence?.presenceDefinition?.systemPresence === 'On Queue'
      ).length;
      const active = filteredUsers.filter(u => {
        if (!u.dateLastLogin) return false;
        const lastLogin = new Date(u.dateLastLogin);
        const today = new Date();
        return lastLogin.toDateString() === today.toDateString();
      }).length;
      const away = filteredUsers.filter(u => {
        const presence = u.presence?.presenceDefinition?.systemPresence || '';
        return presence === 'Away' || presence === 'Breaks' || presence === 'Meal';
      }).length;
      
      document.getElementById('totalUsers').textContent = total;
      document.getElementById('onlineUsers').textContent = online;
      document.getElementById('activeUsers').textContent = active;
      document.getElementById('awayUsers').textContent = away;
    }

    // Column Manager Functions
    function showColumnManager() {
      const modal = document.getElementById('columnManagerModal');
      const searchInput = document.getElementById('columnSearch');
      const columnsContainer = document.getElementById('columnsListContainer');
      
      searchInput.value = '';
      renderColumnList();
      modal.classList.add('open');
      searchInput.focus();
    }

    function renderColumnList(searchTerm = '') {
      const columnsContainer = document.getElementById('columnsListContainer');
      const selectedCountElement = document.getElementById('selectedColumnsCount');
      
      let html = '';
      let totalSelected = 0;
      
      const filteredCategories = {};
      
      Object.keys(columnCategories).forEach(category => {
        const columns = columnCategories[category].filter(column => {
          if (!searchTerm) return true;
          const search = searchTerm.toLowerCase();
          return column.label.toLowerCase().includes(search) || 
                 column.id.toLowerCase().includes(search) ||
                 category.toLowerCase().includes(search);
        });
        
        if (columns.length > 0) {
          filteredCategories[category] = columns;
        }
      });
      
      Object.keys(filteredCategories).forEach(category => {
        const columns = filteredCategories[category];
        let categorySelected = 0;
        
        const columnsHtml = columns.map(column => {
          const isSelected = visibleColumns.includes(column.id);
          if (isSelected) {
            categorySelected++;
            totalSelected++;
          }
          
          return `
            <div class="column-item" data-column-id="${column.id}">
              <input type="checkbox" id="col_${column.id}" ${isSelected ? 'checked' : ''}>
              <label for="col_${column.id}" class="column-label">${column.label}</label>
              <span class="column-type type-${column.type}">${column.type}</span>
            </div>
          `;
        }).join('');
        
        html += `
          <div class="columns-category">
            <div class="category-header" onclick="toggleCategory(this)">
              <h3>${category}</h3>
              <span class="category-count">${categorySelected}/${columns.length}</span>
            </div>
            <div class="category-content">
              ${columnsHtml}
            </div>
          </div>
        `;
      });
      
      columnsContainer.innerHTML = html || '<div style="text-align:center;padding:40px;color:var(--text-light)">No columns found matching your search.</div>';
      
      selectedCountElement.textContent = totalSelected;
      
      document.querySelectorAll('.column-item input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const columnId = this.id.replace('col_', '');
          if (this.checked) {
            if (!visibleColumns.includes(columnId)) {
              visibleColumns.push(columnId);
            }
          } else {
            const index = visibleColumns.indexOf(columnId);
            if (index > -1) {
              visibleColumns.splice(index, 1);
            }
          }
          
          renderColumnList(document.getElementById('columnSearch').value);
        });
      });
    }

    function toggleCategory(header) {
      const categoryContent = header.nextElementSibling;
      if (categoryContent.style.display === 'none') {
        categoryContent.style.display = 'grid';
      } else {
        categoryContent.style.display = 'none';
      }
    }

    function saveColumnPreferences() {
      localStorage.setItem('visibleColumns', JSON.stringify(visibleColumns));
      
      document.getElementById('columnManagerModal').classList.remove('open');
      
      renderTableHeaders();
      renderTable();
      
      showMessage('Column preferences saved', 'success');
    }

    // Column Resizing Functions
    function setupColumnResizing() {
      const table = document.getElementById('usersTable');
      tableElement = table;
      const headers = table.querySelectorAll('thead tr:first-child th');
      
      headers.forEach((header, index) => {
        originalWidths[index] = header.getBoundingClientRect().width;
      });
      
      headers.forEach((header, index) => {
        const resizer = document.createElement('div');
        resizer.classList.add('resizer');
        resizer.dataset.index = index;
        header.appendChild(resizer);
        
        header.style.position = 'relative';
        
        resizer.addEventListener('mousedown', startResize);
        resizer.addEventListener('touchstart', startResizeTouch);
      });
      
      const inactiveTable = document.getElementById('inactiveUsersTable');
      if (inactiveTable) {
        setupInactiveColumnResizing(inactiveTable);
      }
    }
    
    function setupInactiveColumnResizing(table) {
      const headers = table.querySelectorAll('thead tr:first-child th');
      
      headers.forEach((header, index) => {
        const resizer = document.createElement('div');
        resizer.classList.add('resizer');
        resizer.dataset.index = index;
        header.appendChild(resizer);
        
        header.style.position = 'relative';
        
        resizer.addEventListener('mousedown', startResize);
        resizer.addEventListener('touchstart', startResizeTouch);
      });
    }
    
    function startResize(e) {
      e.preventDefault();
      activeResizer = e.target;
      columnIndex = parseInt(activeResizer.dataset.index);
      startX = e.clientX || e.pageX;
      
      const header = activeResizer.parentElement;
      startWidth = header.getBoundingClientRect().width;
      
      activeResizer.classList.add('resizing');
      
      document.addEventListener('mousemove', resize);
      document.addEventListener('mouseup', stopResize);
    }
    
    function startResizeTouch(e) {
      e.preventDefault();
      activeResizer = e.target;
      columnIndex = parseInt(activeResizer.dataset.index);
      startX = e.touches[0].clientX;
      
      const header = activeResizer.parentElement;
      startWidth = header.getBoundingClientRect().width;
      
      activeResizer.classList.add('resizing');
      
      document.addEventListener('touchmove', resizeTouch);
      document.addEventListener('touchend', stopResize);
    }
    
    function resize(e) {
      if (!activeResizer) return;
      
      const currentX = e.clientX || e.pageX;
      const dx = currentX - startX;
      const newWidth = Math.max(50, startWidth + dx);
      
      const header = activeResizer.parentElement;
      const table = header.closest('table');
      const allRows = table.querySelectorAll('tbody tr');
      
      header.style.width = `${newWidth}px`;
      
      allRows.forEach(row => {
        const cell = row.querySelector(`td:nth-child(${columnIndex + 1})`);
        if (cell) {
          cell.style.width = `${newWidth}px`;
        }
      });
      
      e.preventDefault();
    }
    
    function resizeTouch(e) {
      if (!activeResizer) return;
      
      const currentX = e.touches[0].clientX;
      const dx = currentX - startX;
      const newWidth = Math.max(50, startWidth + dx);
      
      const header = activeResizer.parentElement;
      const table = header.closest('table');
      const allRows = table.querySelectorAll('tbody tr');
      
      header.style.width = `${newWidth}px`;
      allRows.forEach(row => {
        const cell = row.querySelector(`td:nth-child(${columnIndex + 1})`);
        if (cell) {
          cell.style.width = `${newWidth}px`;
        }
      });
    }
    
    function stopResize() {
      if (!activeResizer) return;
      
      activeResizer.classList.remove('resizing');
      activeResizer = null;
      
      document.removeEventListener('mousemove', resize);
      document.removeEventListener('mouseup', stopResize);
      document.removeEventListener('touchmove', resizeTouch);
      document.removeEventListener('touchend', stopResize);
    }
    
    function resetColumnWidths() {
      const table = document.getElementById('usersTable');
      const headers = table.querySelectorAll('thead tr:first-child th');
      const rows = table.querySelectorAll('tbody tr');
      
      headers.forEach((header, index) => {
        header.style.width = '';
        rows.forEach(row => {
          const cell = row.querySelector(`td:nth-child(${index + 1})`);
            if (cell) {
            cell.style.width = '';
          }
        });
      });
      
      showMessage('Column sizes reset to default', 'success');
    }
    
    function resetInactiveColumnWidths() {
      const table = document.getElementById('inactiveUsersTable');
      const headers = table.querySelectorAll('thead tr:first-child th');
      const rows = table.querySelectorAll('tbody tr');
      
      headers.forEach((header, index) => {
        header.style.width = '';
        rows.forEach(row => {
          const cell = row.querySelector(`td:nth-child(${index + 1})`);
          if (cell) {
            cell.style.width = '';
          }
        });
      });
      
      showMessage('Inactive users column sizes reset', 'success');
    }

    let teamDropdown, managementUnitDropdown;

    function createCheckboxDropdown(containerId, {placeholder, searchPlaceholder}) {
      const root = document.getElementById(containerId);
      root.innerHTML = '';

      const trigger = document.createElement('div');
      trigger.className = 'cd-trigger';
      trigger.innerHTML = `<span class="label">${placeholder}</span><span class="count">0 selected</span>`;
      root.appendChild(trigger);

      const panel = document.createElement('div');
      panel.className = 'cd-panel';
      panel.innerHTML = `
        <div class="cd-header">
          <input type="text" class="cd-search" placeholder="${searchPlaceholder}" />
          <div class="cd-actions"><button data-cd="clear">Clear</button></div>
        </div>
        <div class="cd-selectall"><label><input type="checkbox" data-cd="selectall"/> Select all</label></div>
        <div class="cd-list"></div>
        <div class="cd-footer"><span data-cd="summary">0 selected</span><span>Click outside to close</span></div>
      `;
      root.appendChild(panel);

      const list = panel.querySelector('.cd-list');
      const search = panel.querySelector('.cd-search');
      const clearBtn = panel.querySelector('[data-cd="clear"]');
      const selectAll = panel.querySelector('[data-cd="selectall"]');
      const summary = panel.querySelector('[data-cd="summary"]');

      let options = [], selected = new Set();

      function render(filter = '') {
        const ft = filter.toLowerCase().trim();
        list.innerHTML = '';
        const filtered = !ft ? options : options.filter(o => (o.label || '').toLowerCase().includes(ft));

        if (!filtered.length) {
          list.innerHTML = `<div class="cd-item" style="color:#6C757D">No matches</div>`;
          return;
        }

        filtered.forEach(o => {
          const id = `${containerId}_${o.value}`;
          const row = document.createElement('div');
          row.className = 'cd-item';
          row.innerHTML = `
            <label for="${id}">
              <input type="checkbox" id="${id}" value="${o.value}" ${selected.has(o.value) ? 'checked' : ''}/>
              <span>${o.label}</span>
            </label>
          `;
          const cb = row.querySelector('input');
          cb.addEventListener('change', () => {
            cb.checked ? selected.add(o.value) : selected.delete(o.value);
            updateSummary();
            updateSelectAllState();
            if (availableUsers.length > 0) {
              applyFilters();
              renderTable();
            }
          });
          list.appendChild(row);
        });
      }

      function updateSummary() {
        trigger.querySelector('.count').textContent = `${selected.size} selected`;
        summary.textContent = `${selected.size} selected`;
      }

      function updateSelectAllState() {
        const total = options.length;
        selectAll.indeterminate = selected.size > 0 && selected.size < total;
        selectAll.checked = total > 0 && selected.size === total;
      }

      trigger.addEventListener('click', () => { panel.classList.toggle('open'); search.focus(); });
      document.addEventListener('click', e => { if (!root.contains(e.target)) panel.classList.remove('open'); });
      search.addEventListener('input', () => render(search.value));

      clearBtn.addEventListener('click', () => {
        selected.clear();
        render(search.value);
        updateSummary();
        updateSelectAllState();
        if (availableUsers.length > 0) {
          applyFilters();
          renderTable();
        }
      });

      selectAll.addEventListener('change', () => {
        if (selectAll.checked) options.forEach(o => selected.add(o.value));
        else selected.clear();
        render(search.value);
        updateSummary();
        if (availableUsers.length > 0) {
          applyFilters();
          renderTable();
        }
      });

      function setOptions(arr) {
        options = arr || [];
        [...selected].forEach(v => { if (!options.some(o => o.value === v)) selected.delete(v) });
        render(search.value);
        updateSummary();
        updateSelectAllState();
      }

      function getSelectedValues() { return [...selected] }

      function setSelectedValues(vals) {
        selected = new Set(vals);
        render(search.value);
        updateSummary();
        updateSelectAllState();
      }

      render();

      return { setOptions, getSelectedValues, setSelectedValues };
    }

    function createDropdowns() {
      teamDropdown = createCheckboxDropdown('teamDropdown', {
        placeholder: 'Select teams',
        searchPlaceholder: 'Search teams...'
      });
      
      managementUnitDropdown = createCheckboxDropdown('managementUnitDropdown', {
        placeholder: 'Select management units',
        searchPlaceholder: 'Search management units...'
      });
    }

    function populateDropdownOptions() {
      const teamOpts = availableTeams
        .map(t => ({ value: t.id, label: t.name }))
        .sort((a, b) => a.label.localeCompare(b.label));
      teamDropdown.setOptions(teamOpts);

      const muOpts = availableManagementUnits
        .map(mu => ({ value: mu.id, label: mu.name }))
        .sort((a, b) => a.label.localeCompare(b.label));
      managementUnitDropdown.setOptions(muOpts);
    }

    function setupTabs() {
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));
          
          tab.classList.add('active');
          const tabId = tab.dataset.tab;
          document.getElementById(tabId).classList.add('active');
        });
      });
    }

    async function findInactiveUsers() {
      if (availableUsers.length === 0) {
        showMessage('Please load users first', 'warning');
        return;
      }
      
      const daysSinceLogin = parseInt(document.getElementById('daysSinceLogin').value) || 30;
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;
      const teamFilter = document.getElementById('inactiveTeamFilter').value;
      
      let filteredInactive = availableUsers.filter(user => {
        if (user.daysSinceLastLogin < daysSinceLogin) {
          return false;
        }
        
        if (dateFrom && user.dateLastLogin) {
          const lastLogin = new Date(user.dateLastLogin);
          const fromDate = new Date(dateFrom);
          if (lastLogin < fromDate) {
            return false;
          }
        }
        
        if (dateTo && user.dateLastLogin) {
          const lastLogin = new Date(user.dateLastLogin);
          const toDate = new Date(dateTo);
          if (lastLogin > toDate) {
            return false;
          }
        }
        
        if (teamFilter && user.team && user.team.id !== teamFilter) {
          return false;
        }
        
        return true;
      });
      
      filteredInactive.sort((a, b) => b.daysSinceLastLogin - a.daysSinceLastLogin);
      
      inactiveUsers = filteredInactive;
      renderInactiveUsersTable();
      updateInactiveStats();
      
      showMessage(`Found ${inactiveUsers.length} inactive users`, 'success');
    }

    async function renderInactiveUsersTable() {
      const tbody = document.querySelector('#inactiveUsersTable tbody');
      
      if (inactiveUsers.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-light)}">
          No inactive users found. Adjust your criteria and try again.
        </td></tr>`;
        return;
      }
      
      const usersToFetch = inactiveUsers.slice(0, 50);
      const queuePromises = usersToFetch.map(user => fetchUserQueues(user.id));
      const queuesList = await Promise.all(queuePromises);
      
      tbody.innerHTML = inactiveUsers.map((user, index) => {
        const status = user.routingStatus?.status || 'UNKNOWN';
        const presence = user.presence?.presenceDefinition?.systemPresence || 'Offline';
        const team = user.team?.name || 'Unassigned';
        const lastLogin = user.dateLastLogin ? 
          new Date(user.dateLastLogin).toLocaleDateString() + ' ' + 
          new Date(user.dateLastLogin).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) 
          : 'Never';
        const daysSinceLogin = user.daysSinceLastLogin || 0;
        const roles = user.roles || [];
        const userQueues = index < queuesList.length ? queuesList[index] : [];
        const skills = user.skills?.map(s => s.name) || [];
        const statusClass = getStatusClass(presence);
        
        let daysClass = '';
        if (daysSinceLogin > 30) daysClass = 'style="color: var(--danger); font-weight: bold;"';
        else if (daysSinceLogin > 7) daysClass = 'style="color: var(--warning);"';
        
        return `
          <tr>
            <td><strong>${user.name || 'Unknown'}</strong></td>
            <td>${user.email || 'No email'}</td>
            <td>
              <div class="roles-list" title="${roles.join(', ') || 'No role'}">
                ${roles.slice(0, 5).map(role => `<span>${role}</span>`).join('')}
                ${roles.length > 5 ? '<span>...</span>' : ''}
                ${roles.length === 0 ? '<span style="color: var(--text-light);">No role</span>' : ''}
              </div>
            </td>
            <td>${team}</td>
            <td>${lastLogin}</td>
            <td style="text-align:center;" ${daysClass}>${daysSinceLogin === 999 ? 'Never' : daysSinceLogin}</td>
            <td><span class="status-badge ${statusClass}">${presence}</span></td>
            <td>
              <div class="queues-list" title="${userQueues.join(', ')}">
                ${userQueues.slice(0, 5).map(queue => `<span>${queue}</span>`).join('')}
                ${userQueues.length > 5 ? '<span>...</span>' : ''}
                ${userQueues.length === 0 ? '<span style="color: var(--text-light);">None</span>' : ''}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function updateInactiveStats() {
      if (inactiveUsers.length === 0) {
        document.getElementById('totalInactiveUsers').textContent = '0';
        document.getElementById('avgDaysInactive').textContent = '0';
        document.getElementById('maxDaysInactive').textContent = '0';
        return;
      }
      
      const total = inactiveUsers.length;
      const avgDays = Math.round(inactiveUsers.reduce((sum, user) => sum + user.daysSinceLastLogin, 0) / total);
      const maxDays = Math.max(...inactiveUsers.map(user => user.daysSinceLastLogin));
      
      document.getElementById('totalInactiveUsers').textContent = total;
      document.getElementById('avgDaysInactive').textContent = avgDays;
      document.getElementById('maxDaysInactive').textContent = maxDays;
    }

    function setupEventListeners() {
      document.getElementById('fetchUsers').addEventListener('click', fetchUsers);
      
      document.getElementById('findInactiveUsers').addEventListener('click', findInactiveUsers);
      
      document.getElementById('refreshData').addEventListener('click', async () => {
        if (availableUsers.length === 0) {
          await fetchUsers();
        } else {
          applyFilters();
          renderTable();
        }
        showMessage('Data refreshed', 'success');
      });
      
      document.getElementById('refreshRoles').addEventListener('click', () => {
        if (availableUsers.length === 0) {
          showMessage('Please load users first', 'warning');
          return;
        }
        updateRolesData();
        showMessage('Roles data refreshed', 'success');
      });
      
      document.getElementById('exportCSV').addEventListener('click', exportToCSV);
      
      document.getElementById('exportInactiveCSV').addEventListener('click', exportInactiveToCSV);
      
      document.getElementById('exportRolesCSV').addEventListener('click', exportRolesSummaryToCSV);
      
      document.getElementById('showAllUsers').addEventListener('click', () => {
        if (availableUsers.length === 0) {
          showMessage('Please load users first', 'warning');
          return;
        }
        
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        document.querySelector('.tab[data-tab="active-users"]').classList.add('active');
        document.getElementById('active-users').classList.add('active');
        
        clearFilters();
        
        showMessage('Showing all users', 'success');
      });
      
      document.getElementById('clearFilters').addEventListener('click', clearFilters);
      
      document.getElementById('resetColumnWidths').addEventListener('click', resetColumnWidths);
      
      document.getElementById('resetInactiveColumnWidths').addEventListener('click', resetInactiveColumnWidths);
      
      // Column manager event listeners
      document.getElementById('manageColumns').addEventListener('click', showColumnManager);
      document.getElementById('closeColumnManager').addEventListener('click', () => {
        document.getElementById('columnManagerModal').classList.remove('open');
      });
      document.getElementById('cancelColumns').addEventListener('click', () => {
        document.getElementById('columnManagerModal').classList.remove('open');
      });
      
      document.getElementById('saveColumns').addEventListener('click', saveColumnPreferences);
      
      document.getElementById('columnSearch').addEventListener('input', function() {
        renderColumnList(this.value);
      });
      
      document.getElementById('selectAllColumns').addEventListener('click', function() {
        allColumns.forEach(column => {
          if (!visibleColumns.includes(column.id)) {
            visibleColumns.push(column.id);
          }
        });
        renderColumnList(document.getElementById('columnSearch').value);
      });
      
      document.getElementById('deselectAllColumns').addEventListener('click', function() {
        visibleColumns = [];
        renderColumnList(document.getElementById('columnSearch').value);
      });
      
      document.getElementById('resetToDefault').addEventListener('click', function() {
        visibleColumns = [...DEFAULT_VISIBLE_COLUMNS];
        renderColumnList(document.getElementById('columnSearch').value);
      });
      
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('columnManagerModal').classList.contains('open')) {
          document.getElementById('columnManagerModal').classList.remove('open');
        }
      });
      
      document.getElementById('columnManagerModal').addEventListener('click', function(e) {
        if (e.target === this) {
          this.classList.remove('open');
        }
      });
      
      document.getElementById('pageSize').addEventListener('change', function() {
        pageSize = parseInt(this.value);
        currentPage = 1;
        renderTable();
      });
      
      document.getElementById('prevPage').addEventListener('click', () => {
        currentPage--;
        renderTable();
      });
      
      document.getElementById('nextPage').addEventListener('click', () => {
        currentPage++;
        renderTable();
      });
      
      document.getElementById('globalSearch').addEventListener('input', function() {
        globalSearch = this.value;
        currentPage = 1;
        applyFilters();
        renderTable();
      });
      
      document.getElementById('roleSearch').addEventListener('input', function() {
        renderRoles();
      });
      
      document.getElementById('roleTeamFilter').addEventListener('change', function() {
        renderRoles();
      });
      
      document.getElementById('statusFilter').addEventListener('change', function() {
        currentPage = 1;
        applyFilters();
        renderTable();
      });
      
      // Note: Column filter event listeners are now added dynamically in renderTableHeaders
    }

    function exportToCSV() {
      if (filteredUsers.length === 0) {
        showMessage('No data to export', 'info');
        return;
      }
      
      const headers = visibleColumns.map(columnId => {
        const column = allColumns.find(c => c.id === columnId);
        return column ? column.label : columnId;
      });
      
      headers.push('User ID');
      
      const data = filteredUsers.map(user => {
        const row = visibleColumns.map(columnId => {
          let value = getNestedValue(user, columnId);
          
          if (columnId === 'skills.name') {
            const skills = user.skills?.map(s => s.name) || [];
            return skills.join('; ');
          }
          
          if (columnId === 'authorization.roles.name') {
            const roles = user.roles || [];
            return roles.join('; ');
          }
          
          if (columnId === 'dateLastLogin' && value) {
            return new Date(value).toISOString();
          }
          
          if (Array.isArray(value)) {
            return value.join('; ');
          }
          
          if (typeof value === 'object' && value !== null) {
            return JSON.stringify(value);
          }
          
          return value || '';
        });
        
        row.push(user.id || '');
        
        return row;
      });
      
      const csvContent = [
        headers.join(','),
        ...data.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
      ].join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `users_export_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      showMessage(`Exported ${filteredUsers.length} users to CSV with ${visibleColumns.length} columns`, 'success');
    }

    function exportInactiveToCSV() {
      if (inactiveUsers.length === 0) {
        showMessage('No inactive users to export', 'info');
        return;
      }
      
      const headers = [
        'Name', 'Email', 'Role', 'Team', 'Last Login', 
        'Days Since Login', 'Status', 'User ID'
      ];
      
      const data = inactiveUsers.map(user => [
        user.name || '',
        user.email || '',
        user.roles?.join('; ') || '',
        user.team?.name || '',
        user.dateLastLogin ? new Date(user.dateLastLogin).toISOString() : '',
        user.daysSinceLastLogin || 0,
        user.presence?.presenceDefinition?.systemPresence || '',
        user.id || ''
      ]);
      
      const csvContent = [
        headers.join(','),
        ...data.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
      ].join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `inactive_users_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      showMessage(`Exported ${inactiveUsers.length} inactive users to CSV`, 'success');
    }

    function exportRolesSummaryToCSV() {
      const sortedRoles = Object.keys(rolesData).sort((a, b) => 
        rolesData[b].users.length - rolesData[a].users.length
      );
      
      if (sortedRoles.length === 0) {
        showMessage('No roles data to export', 'info');
        return;
      }
      
      const headers = [
        'Role Name', 'User Count', 'Team Count', 'Teams', 'Sample Users'
      ];
      
      const data = sortedRoles.map(role => {
        const roleInfo = rolesData[role];
        const teams = Array.from(roleInfo.teams);
        const sampleUsers = roleInfo.users.slice(0, 3).map(u => u.name).join('; ');
        
        return [
          role,
          roleInfo.users.length,
          teams.length,
          teams.join('; '),
          sampleUsers
        ];
      });
      
      const csvContent = [
        headers.join(','),
        ...data.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
      ].join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `roles_summary_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      showMessage(`Exported ${sortedRoles.length} roles to CSV`, 'success');
    }

    function clearFilters() {
      filters = {};
      globalSearch = '';
      document.getElementById('globalSearch').value = '';
      document.getElementById('statusFilter').value = '';
      teamDropdown.setSelectedValues([]);
      managementUnitDropdown.setSelectedValues([]);
      
      document.querySelectorAll('.column-filter').forEach(input => {
        input.value = '';
      });
      
      currentPage = 1;
      applyFilters();
      renderTable();
      showMessage('All filters cleared', 'success');
    }

    function showLoading(show) {
      document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }

    window.addEventListener('load', () => {
    });

    // Make functions available globally for onclick handlers
    window.viewRoleUsers = viewRoleUsers;
    window.exportRoleUsers = exportRoleUsers;
    window.toggleCategory = toggleCategory;

  </script>
</body>
</html>
